/*!
 * maptalks.three v0.35.1
 * LICENSE : MIT
 * (c) 2016-2022 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).maptalks=t.maptalks||{},t.maptalks,t.THREE)}(this,(function(t,e,n){"use strict";function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}function r(t,e){return e.forEach((function(e){e&&"string"!=typeof e&&!Array.isArray(e)&&Object.keys(e).forEach((function(n){if("default"!==n&&!(n in t)){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})}}))})),Object.freeze(t)}var o=i(e),s=i(n);const a=parseInt(s.REVISION.replace("dev",""));function l(t,e,n){return a>109?t.setAttribute(e,n):t.addAttribute(e,n),t}function h(){return!s.VertexColors||s.VertexColors}console.log(`maptalks.three log: current three.js version is %c${a}`,"color:red;font-size: 16px;font-weight: bold;");class c extends s.InstancedBufferGeometry{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),l(this,"position",new s.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),l(this,"uv",new s.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix(t){var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(n),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new s.InstancedInterleavedBuffer(e,6,1);return l(this,"instanceStart",new s.InterleavedBufferAttribute(n,3,0)),l(this,"instanceEnd",new s.InterleavedBufferAttribute(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new s.InstancedInterleavedBuffer(e,6,1);return l(this,"instanceColorStart",new s.InterleavedBufferAttribute(n,3,0)),l(this,"instanceColorEnd",new s.InterleavedBufferAttribute(n,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new s.WireframeGeometry(t.geometry)),this}fromLineSegements(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}computeBoundingBox(){var t=new s.Box3;null===this.boundingBox&&(this.boundingBox=new s.Box3);var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;void 0!==e&&void 0!==n&&(this.boundingBox.setFromBufferAttribute(e),t.setFromBufferAttribute(n),this.boundingBox.union(t))}computeBoundingSphere(){var t=new s.Vector3;null===this.boundingSphere&&(this.boundingSphere=new s.Sphere),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;if(void 0!==e&&void 0!==n){var i=this.boundingSphere.center;this.boundingBox.getCenter(i);for(var r=0,o=0,a=e.count;o<a;o++)t.fromBufferAttribute(e,o),r=Math.max(r,i.distanceToSquared(t)),t.fromBufferAttribute(n,o),r=Math.max(r,i.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}copy(t){return this}}const u={},d={};u.line={linewidth:{value:1},resolution:{value:new s.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},d.line={uniforms:s.UniformsUtils.merge([s.UniformsLib.common,s.UniformsLib.fog,u.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};class f extends s.ShaderMaterial{constructor(t){super({uniforms:s.UniformsUtils.clone(d.line.uniforms),vertexShader:d.line.vertexShader,fragmentShader:d.line.fragmentShader}),this.dashed=!0,this.isLineMaterial=!0,this.type="LineMaterial",Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)}}class p extends s.Mesh{constructor(t,e){super(t,e),this.isLineSegments2=!0,this.type="LineSegments2",this.geometry=void 0!==t?t:new c,this.material=void 0!==e?e:new f({color:16777215*Math.random()})}computeLineDistances(){var t=new s.Vector3,e=new s.Vector3,n=this.geometry,i=n.attributes.instanceStart,r=n.attributes.instanceEnd;if(!i||!r)return this;for(var o=new Float32Array(2*i.data.count),a=0,h=0,c=i.data.count;a<c;a++,h+=2)t.fromBufferAttribute(i,a),e.fromBufferAttribute(r,a),o[h]=0===h?0:o[h-1],o[h+1]=o[h]+t.distanceTo(e);var u=new s.InstancedInterleavedBuffer(o,2,1);return l(n,"instanceDistanceStart",new s.InterleavedBufferAttribute(u,1,0)),l(n,"instanceDistanceEnd",new s.InterleavedBufferAttribute(u,1,1)),this}}class g extends c{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}fromLine(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}}class y extends p{constructor(t,e){super(t,e),this.isLine2=!0,this.type="Line2",this.geometry=void 0!==t?t:new g,this.material=void 0!==e?e:new f({color:16777215*Math.random()})}copy(t){return this}}const x={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1,bloom:!1};function v(){}class m extends(o.Eventable(v)){constructor(t){super(),this.isAdd=!1,this._mouseover=!1,this._visible=!0,this._zoomVisible=!0,this.picked=!1,this.isBaseObject=!0,void 0===t&&(t=o.Util.GUID()),this.id=t}addTo(t){return t&&"ThreeLayer"===t.type?t.addMesh([this]):console.error("layer only support maptalks.ThreeLayer"),this}remove(){const t=this.getLayer();return t&&t.removeMesh([this]),this}getObject3d(){return this.object3d}getId(){return this.id}setId(t){const e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this}getType(){return this.type}getOptions(){return this.options}getProperties(){return(this.options||{}).properties}setProperties(t){const e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this}getLayer(){return this.options.layer}getMap(){const t=this.getLayer();if(t)return t.getMap()}getCenter(){const t=this.getOptions(),{coordinate:e,lineString:n,polygon:i}=t;if(e)return e instanceof o.Coordinate?e:new o.Coordinate(e);{const t=i||n;if(t&&t.getCenter)return t.getCenter()}}getAltitude(){return this.getOptions().altitude}setAltitude(t){if(o.Util.isNumber(t)){const e=this.getLayer().altitudeToVector3(t,t).x;if(this.getObject3d().position.z=e,this.options.altitude=t,this.pickObject3d&&(this.pickObject3d.position.z=e),this._baseObjects&&Array.isArray(this._baseObjects))for(let t=0,n=this._baseObjects.length;t<n;t++)this._baseObjects[t]&&(this._baseObjects[t].getObject3d().position.z=e)}return this}supportHeight(){return this.getOptions().heightEnable}getHeight(){const{height:t}=this.getOptions();return o.Util.isNumber(t)?t:0}setHeight(t){if(!o.Util.isNumber(t)||this._baseObjects||!this.supportHeight())return this;const e=this.getLayer();if(!e)return this;const{geometry:n}=this.getObject3d();if(n instanceof s.BufferGeometry){const{position:i}=n.attributes||{};if(!i)return this;const r=i.array;let o=1/0,s=-1/0;for(let t=0,e=r.length;t<e;t+=3){const e=r[t+2];o=Math.min(e,o),s=Math.max(e,s)}const a=(o+s)/2;let l=e.altitudeToVector3(t,t).x;l=Math.max(l,1e-6);for(let t=0,e=r.length;t<e;t+=3)r[t+2]>a&&(r[t+2]=l);n.attributes.position.needsUpdate=!0,n.computeBoundingBox(),n.computeBoundingSphere(),this.getOptions().height=t}return this}show(){return this._zoomVisible&&(this.getObject3d().visible=!0,this._fire("show")),this._visible=!0,this}hide(){return this.getObject3d().visible=!1,this._fire("hide"),this._visible=!1,this._hideUI(),this}isVisible(){return!!this.getObject3d().visible}getSymbol(){return this.getObject3d().material}setSymbol(t){if(t&&t instanceof s.Material){t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors;const e=this.getObject3d().material.clone();this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})}return this}setInfoWindow(t){return this.removeInfoWindow(),this.infoWindow=new o.ui.InfoWindow(t),this.infoWindow.addTo(this),this}getInfoWindow(){return this.infoWindow}openInfoWindow(t){return(t=t||this.getCenter())instanceof o.Coordinate||(t=new o.Coordinate(t)),t&&this.infoWindow&&this.infoWindow.show(t),this}closeInfoWindow(){return this.infoWindow&&this.infoWindow.hide(),this}removeInfoWindow(){return this.infoWindow&&(this.infoWindow.remove(),delete this.infoWindow),this}setToolTip(t,e){return this.removeToolTip(),this.toolTip=new o.ui.ToolTip(t,e),this.toolTip.addTo(this),this}getToolTip(){return this.toolTip}openToolTip(t){return(t=t||this.getCenter())instanceof o.Coordinate||(t=new o.Coordinate(t)),t&&this.toolTip&&this.toolTip.show(t),this}closeToolTip(){return this.toolTip&&this.toolTip.hide(),this}removeToolTip(){return this.toolTip&&(this.toolTip.remove(),delete this.toolTip),this}_hideUI(){return this.closeInfoWindow(),this.closeToolTip(),this}animateShow(t={},e){this._showPlayer&&this._showPlayer.cancel(),o.Util.isFunction(t)&&(e=t={});const n=t.duration||1e3,i=t.easing||"out",r=this._showPlayer=o.animation.Animation.animate({scale:1},{duration:n,easing:i},(t=>{const n=t.styles.scale;n>0&&(this.getObject3d().scale.z=n),e&&e(t,n)}));return r.play(),r}getMinZoom(){return this.getOptions().minZoom}getMaxZoom(){return this.getOptions().maxZoom}isAsynchronous(){return this.getOptions().asynchronous}get bloom(){return this.getOptions().bloom}fire(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this}config(){return this}setPickObject3d(t){return this.pickObject3d=t,this.pickObject3d.__parent=this,this}_initOptions(t){return this.options=o.Util.extend({},x,t),this}_createMesh(t,e){return this.object3d=new s.Mesh(t,e),this.object3d.__parent=this,this}_createInstancedMesh(t,e,n){return this.object3d=new s.InstancedMesh(t,e,n),this.object3d.__parent=this,this}_createGroup(){return this.object3d=new s.Group,this.object3d.__parent=this,this}_createLine(t,e){return this.object3d=new s.Line(t,e),this._computeLineDistances(t),this.object3d.__parent=this,this}_createLine2(t,e){return this.object3d=new y(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this}_createPoints(t,e){return this.object3d=new s.Points(t,e),this.object3d.__parent=this,this}_createLineSegments(t,e){return this.object3d=new s.LineSegments(t,e),this._computeLineDistances(t),this.object3d.__parent=this,this}_computeLineDistances(t){const e=t.attributes.position.array,n=t.attributes.position.count,i=new Float32Array(n);i[0]=0;const r=new s.Vector3(0,0,0),o=new s.Vector3(0,0,0);for(let t=1;t<n;t++){const n=3*(t-1);r.x=e[n],r.y=e[n+1],r.z=e[n+2];const s=3*t;o.x=e[s],o.y=e[s+1],o.z=e[s+2];const a=o.distanceTo(r);i[t]=i[t-1]+a}l(t,"lineDistance",new s.BufferAttribute(i,1))}}const b=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function _(t){return t.geometry?t.geometry.type:null}function w(t){const e=_(t);if(e)for(let t=0,n=b.length;t<n;t++)if(b[t]===e)return!0;return!1}function M(t){const e=_(t);return!(!e||e!==b[4]&&e!==b[5])}function O(t){const e=_(t);return!(!e||e!==b[2]&&e!==b[3])}function A(t){const e=_(t);return!(!e||e!==b[0]&&e!==b[1])}function j(t){const e=_(t);return!!(e&&e.indexOf("Multi")>-1)}function S(t){return t.geometry?t.geometry.coordinates:[]}function T(t,e){const n=_(t);if(!n||!t.geometry)return null;const i=t.geometry.coordinates;if(!i)return null;let r=0,s=0,a=0;switch(n){case"Point":r=i[0],s=i[1],a++;break;case"MultiPoint":case"LineString":for(let t=0,e=i.length;t<e;t++)r+=i[t][0],s+=i[t][1],a++;break;case"MultiLineString":case"Polygon":for(let t=0,e=i.length;t<e;t++)for(let e=0,n=i[t].length;e<n;e++)r+=i[t][e][0],s+=i[t][e][1],a++;break;case"MultiPolygon":for(let t=0,e=i.length;t<e;t++)for(let e=0,n=i[t].length;e<n;e++)for(let n=0,o=i[t][e].length;n<o;n++)r+=i[t][e][n][0],s+=i[t][e][n][1],a++}const l=r/a,h=s/a;return e?(e.x=l,e.y=h,e):new o.Coordinate(l,h)}function C(t){const e=_(t);if(!e||!t.geometry)return null;const n=t.geometry,i=t.properties||{},r=n.coordinates;if(!r)return null;const o=[];let s;switch(e){case"MultiPoint":s="Point";break;case"MultiLineString":s="LineString";break;case"MultiPolygon":s="Polygon"}if(s)for(let t=0,e=r.length;t<e;t++)o.push({type:"Feature",geometry:{type:s,coordinates:r[t]},properties:i});else o.push(t);return o}var k=Object.freeze({__proto__:null,isGeoJSON:w,isGeoJSONPolygon:M,isGeoJSONLine:O,isGeoJSONPoint:A,isGeoJSONMulti:j,getGeoJSONCoordinates:S,getGeoJSONCenter:T,spliteGeoJSONMulti:C});"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function P(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var L={exports:{}};
/*!
     * poly-extrude v0.2.0
      */!function(t,e){!function(t){var e={exports:{}};function n(t,e,n){n=n||2;var r,s,a,l,h,u,d,f=e&&e.length,p=f?e[0]*n:t.length,g=i(t,0,p,n,!0),y=[];if(!g||g.next===g.prev)return y;if(f&&(g=c(t,e,g,n)),t.length>80*n){r=a=t[0],s=l=t[1];for(var x=n;x<p;x+=n)(h=t[x])<r&&(r=h),(u=t[x+1])<s&&(s=u),h>a&&(a=h),u>l&&(l=u);d=0!==(d=Math.max(a-r,l-s))?32767/d:0}return o(g,y,n,r,s,d,0),y}function i(t,e,n,i,r){var o,s;if(r===B(t,e,n,i)>0)for(o=e;o<n;o+=i)s=k(o,t[o],t[o+1],s);else for(o=n-i;o>=e;o-=i)s=k(o,t[o],t[o+1],s);return s&&w(s,s.next)&&(P(s),s=s.next),s}function r(t,e){if(!t)return t;e||(e=t);var n,i=t;do{if(n=!1,i.steiner||!w(i,i.next)&&0!==_(i.prev,i,i.next))i=i.next;else{if(P(i),(i=e=i.prev)===i.next)break;n=!0}}while(n||i!==e);return e}function o(t,e,n,i,c,u,d){if(t){!d&&u&&g(t,i,c,u);for(var f,p,y=t;t.prev!==t.next;)if(f=t.prev,p=t.next,u?a(t,i,c,u):s(t))e.push(f.i/n|0),e.push(t.i/n|0),e.push(p.i/n|0),P(t),t=p.next,y=p.next;else if((t=p)===y){d?1===d?o(t=l(r(t),e,n),e,n,i,c,u,2):2===d&&h(t,e,n,i,c,u):o(r(t),e,n,i,c,u,1);break}}}function s(t){var e=t.prev,n=t,i=t.next;if(_(e,n,i)>=0)return!1;for(var r=e.x,o=n.x,s=i.x,a=e.y,l=n.y,h=i.y,c=r<o?r<s?r:s:o<s?o:s,u=a<l?a<h?a:h:l<h?l:h,d=r>o?r>s?r:s:o>s?o:s,f=a>l?a>h?a:h:l>h?l:h,p=i.next;p!==e;){if(p.x>=c&&p.x<=d&&p.y>=u&&p.y<=f&&m(r,a,o,l,s,h,p.x,p.y)&&_(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function a(t,e,n,i){var r=t.prev,o=t,s=t.next;if(_(r,o,s)>=0)return!1;for(var a=r.x,l=o.x,h=s.x,c=r.y,u=o.y,d=s.y,f=a<l?a<h?a:h:l<h?l:h,p=c<u?c<d?c:d:u<d?u:d,g=a>l?a>h?a:h:l>h?l:h,y=c>u?c>d?c:d:u>d?u:d,v=x(f,p,e,n,i),b=x(g,y,e,n,i),w=t.prevZ,M=t.nextZ;w&&w.z>=v&&M&&M.z<=b;){if(w.x>=f&&w.x<=g&&w.y>=p&&w.y<=y&&w!==r&&w!==s&&m(a,c,l,u,h,d,w.x,w.y)&&_(w.prev,w,w.next)>=0)return!1;if(w=w.prevZ,M.x>=f&&M.x<=g&&M.y>=p&&M.y<=y&&M!==r&&M!==s&&m(a,c,l,u,h,d,M.x,M.y)&&_(M.prev,M,M.next)>=0)return!1;M=M.nextZ}for(;w&&w.z>=v;){if(w.x>=f&&w.x<=g&&w.y>=p&&w.y<=y&&w!==r&&w!==s&&m(a,c,l,u,h,d,w.x,w.y)&&_(w.prev,w,w.next)>=0)return!1;w=w.prevZ}for(;M&&M.z<=b;){if(M.x>=f&&M.x<=g&&M.y>=p&&M.y<=y&&M!==r&&M!==s&&m(a,c,l,u,h,d,M.x,M.y)&&_(M.prev,M,M.next)>=0)return!1;M=M.nextZ}return!0}function l(t,e,n){var i=t;do{var o=i.prev,s=i.next.next;!w(o,s)&&M(o,i,i.next,s)&&S(o,s)&&S(s,o)&&(e.push(o.i/n|0),e.push(i.i/n|0),e.push(s.i/n|0),P(i),P(i.next),i=t=s),i=i.next}while(i!==t);return r(i)}function h(t,e,n,i,s,a){var l=t;do{for(var h=l.next.next;h!==l.prev;){if(l.i!==h.i&&b(l,h)){var c=C(l,h);return l=r(l,l.next),c=r(c,c.next),o(l,e,n,i,s,a,0),void o(c,e,n,i,s,a,0)}h=h.next}l=l.next}while(l!==t)}function c(t,e,n,r){var o,s,a,l=[];for(o=0,s=e.length;o<s;o++)(a=i(t,e[o]*r,o<s-1?e[o+1]*r:t.length,r,!1))===a.next&&(a.steiner=!0),l.push(v(a));for(l.sort(u),o=0;o<l.length;o++)n=d(l[o],n);return n}function u(t,e){return t.x-e.x}function d(t,e){var n=f(t,e);if(!n)return e;var i=C(n,t);return r(i,i.next),r(n,n.next)}function f(t,e){var n,i=e,r=t.x,o=t.y,s=-1/0;do{if(o<=i.y&&o>=i.next.y&&i.next.y!==i.y){var a=i.x+(o-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=r&&a>s&&(s=a,n=i.x<i.next.x?i:i.next,a===r))return n}i=i.next}while(i!==e);if(!n)return null;var l,h=n,c=n.x,u=n.y,d=1/0;i=n;do{r>=i.x&&i.x>=c&&r!==i.x&&m(o<u?r:s,o,c,u,o<u?s:r,o,i.x,i.y)&&(l=Math.abs(o-i.y)/(r-i.x),S(i,t)&&(l<d||l===d&&(i.x>n.x||i.x===n.x&&p(n,i)))&&(n=i,d=l)),i=i.next}while(i!==h);return n}function p(t,e){return _(t.prev,t,e.prev)<0&&_(e.next,t,t.next)<0}function g(t,e,n,i){var r=t;do{0===r.z&&(r.z=x(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,y(r)}function y(t){var e,n,i,r,o,s,a,l,h=1;do{for(n=t,t=null,o=null,s=0;n;){for(s++,i=n,a=0,e=0;e<h&&(a++,i=i.nextZ);e++);for(l=h;a>0||l>0&&i;)0!==a&&(0===l||!i||n.z<=i.z)?(r=n,n=n.nextZ,a--):(r=i,i=i.nextZ,l--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;n=i}o.nextZ=null,h*=2}while(s>1);return t}function x(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function v(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function m(t,e,n,i,r,o,s,a){return(r-s)*(e-a)>=(t-s)*(o-a)&&(t-s)*(i-a)>=(n-s)*(e-a)&&(n-s)*(o-a)>=(r-s)*(i-a)}function b(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!j(t,e)&&(S(t,e)&&S(e,t)&&T(t,e)&&(_(t.prev,t,e.prev)||_(t,e.prev,e))||w(t,e)&&_(t.prev,t,t.next)>0&&_(e.prev,e,e.next)>0)}function _(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function w(t,e){return t.x===e.x&&t.y===e.y}function M(t,e,n,i){var r=A(_(t,e,n)),o=A(_(t,e,i)),s=A(_(n,i,t)),a=A(_(n,i,e));return r!==o&&s!==a||!(0!==r||!O(t,n,e))||!(0!==o||!O(t,i,e))||!(0!==s||!O(n,t,i))||!(0!==a||!O(n,e,i))}function O(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function A(t){return t>0?1:t<0?-1:0}function j(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&M(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}function S(t,e){return _(t.prev,t,t.next)<0?_(t,e,t.next)>=0&&_(t,t.prev,e)>=0:_(t,e,t.prev)<0||_(t,t.next,e)<0}function T(t,e){var n=t,i=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}function C(t,e){var n=new L(t.i,t.x,t.y),i=new L(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function k(t,e,n,i){var r=new L(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function P(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function L(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function B(t,e,n,i){for(var r=0,o=e,s=n-i;o<n;o+=i)r+=(t[s]-t[o])*(t[o+1]+t[s+1]),s=o;return r}e.exports=n,e.exports.default=n,n.deviation=function(t,e,n,i){var r=e&&e.length,o=r?e[0]*n:t.length,s=Math.abs(B(t,0,o,n));if(r)for(var a=0,l=e.length;a<l;a++){var h=e[a]*n,c=a<l-1?e[a+1]*n:t.length;s-=Math.abs(B(t,h,c,n))}var u=0;for(a=0;a<i.length;a+=3){var d=i[a]*n,f=i[a+1]*n,p=i[a+2]*n;u+=Math.abs((t[d]-t[p])*(t[f+1]-t[d+1])-(t[d]-t[f])*(t[p+1]-t[d+1]))}return 0===s&&0===u?0:Math.abs((u-s)/s)},n.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},i=0,r=0;r<t.length;r++){for(var o=0;o<t[r].length;o++)for(var s=0;s<e;s++)n.vertices.push(t[r][o][s]);r>0&&(i+=t[r-1].length,n.holes.push(i))}return n};var z=e.exports;function I(t){for(var e,n,i=0,r=1,o=t.length;r<o;)e=n||t[0],i+=((n=t[r])[0]-e[0])*(n[1]+e[1]),r++;return i>0}function E(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function U(t,e){var n=e[0],i=e[1],r=e[2],o=Math.sqrt(n*n+i*i+r*r)||1;return t[0]=n/o,t[1]=i/o,t[2]=r/o,t}function F(t,e,n){var i=e[0],r=e[1],o=e[2],s=n[0],a=n[1],l=n[2];return t[0]=r*l-o*a,t[1]=o*s-i*l,t[2]=i*a-r*s,t}function V(t,e){function n(t,e,n,i){t[0]=e,t[1]=n,t[2]=i}for(var i=[],r=[],o=[],s=[],a=[],l=[],h=t.length,c=new Float32Array(e.length),u=0;u<h;){var d=3*t[u],f=3*t[u+1],p=3*t[u+2];n(i,e[d],e[d+1],e[d+2]),n(r,e[f],e[f+1],e[f+2]),n(o,e[p],e[p+1],e[p+2]),E(a,o,r),E(s,i,r),F(l,a,s);for(var g=0;g<3;g++)c[d+g]+=l[g],c[f+g]+=l[g],c[p+g]+=l[g];u+=3}for(var y=0,x=c.length;y<x;)n(l,c[y],c[y+1],c[y+2]),U(l,l),c[y]=l[0]||0,c[y+1]=l[1]||0,c[y+2]=l[2]||0,y+=3;return c}function R(t){if(1===t.length)return{position:t[0].position,normal:t[0].normal,uv:t[0].uv,indices:t[0].indices,results:t};for(var e=0,n=0,i=0,r=t.length;i<r;i++){var o=t[i],s=o.position,a=o.indices;e+=s.length,n+=a.length}for(var l={position:new Float32Array(e),normal:new Float32Array(e),uv:new Float32Array(e/3*2),indices:new Uint32Array(n),results:t},h=0,c=0,u=0,d=0,f=0,p=t.length;f<p;f++){var g=t[f],y=g.position,x=g.indices,v=g.normal,m=g.uv;l.position.set(y,h),l.normal.set(v,h),l.uv.set(m,d);for(var b=0,_=x.length;b<_;){var w=x[b]+c;l.indices[u]=w,u++,b++}d+=m.length,h+=y.length,c+=y.length/3}return l}function G(t){return 180*t/Math.PI}function Z(t){return t/180*Math.PI}function D(t,e,n,i,r,o){var s=3*n,a=3*i,l=3*r,h=3*o,c=e[s],u=e[s+1],d=e[s+2],f=e[a],p=e[a+1],g=e[a+2],y=e[l],x=e[l+1],v=e[l+2],m=e[h],b=e[h+1],_=e[h+2];Math.abs(u-p)<Math.abs(c-f)?(t.push(c,1-d),t.push(f,1-g),t.push(y,1-v),t.push(m,1-_)):(t.push(u,1-d),t.push(p,1-g),t.push(x,1-v),t.push(b,1-_))}function H(t,e){e=Object.assign({},{depth:2},e);var n=t.map((function(t){for(var n=0,i=t.length;n<i;n++){var r=t[n];K(r),0===n?I(r)||(t[n]=r.reverse()):I(r)&&(t[n]=r.reverse()),J(r)&&r.splice(r.length-1,1)}var o=q(t,e);return o.polygon=t,Q(o,z(o.flatVertices,o.holes,2)),W(o,e),o.position=new Float32Array(o.points),o.indices=new Uint32Array(o.index),o.uv=new Float32Array(o.uvs),o.normal=V(o.indices,o.position),o})),i=R(n);return i.polygons=t,i}function Q(t,e){for(var n=[],i=t.count,r=0,o=e.length;r<o;r+=3){var s=e[r],a=e[r+1],l=e[r+2];n[r]=s,n[r+1]=a,n[r+2]=l;var h=o+r,c=i+s,u=i+a,d=i+l;n[h]=c,n[h+1]=u,n[h+2]=d}t.index=n}function W(t,e){for(var n=t.points,i=t.index,r=t.polygon,o=t.uvs,s=e.depth,a=0,l=r.length;a<l;a++)for(var h=r[a],c=0,u=h.length;c<u;){var d=h[c],f=h[c+1];c===u-1&&(f=h[0]);var p=n.length/3,g=d[0],y=d[1],x=f[0],v=f[1];n.push(g,y,s,x,v,s,g,y,0,x,v,0);var m=p+2,b=p+3,_=p,w=p+1;i.push(m,_,b,_,w,b),D(o,n,m,b,_,w),c++}}function N(t){for(var e=0,n=0,i=t.length;n<i;)e+=t[n].length,n++;return e}function q(t,e){for(var n=N(t),i=t.length,r=[],o=new Float32Array(2*n),s=[],a=[],l=3*n,h=2*n,c=e.depth,u=0,d=0,f=0,p=0;p<i;p++){var g=t[p];p>0&&r.push(u/2);for(var y=0,x=g.length;y<x;){var v=g[y],m=v[0],b=v[1];o[u++]=m,o[u++]=b,s[d]=m,s[d+1]=b,s[d+2]=c,s[l+d]=m,s[l+d+1]=b,s[l+d+2]=0,a[f]=m,a[f+1]=b,a[h+f]=m,a[h+f+1]=b,d+=3,f+=2,y++}}return{flatVertices:o,holes:r,points:s,count:n,uvs:a}}function K(t){J(t)||t.push(t[0])}function J(t){var e=t.length,n=t[0],i=n[0],r=n[1],o=t[e-1],s=o[0],a=o[1];return i===s&&r===a}function Y(t,e){e=Object.assign({},{depth:2,lineWidth:1},e);var n=t.map((function(t){var n=nt(t,e);return n.line=t,$(n,e),X(n,e),n.position=new Float32Array(n.points),n.indices=new Uint32Array(n.index),n.uv=new Float32Array(n.uvs),n.normal=V(n.indices,n.position),n})),i=R(n);return i.lines=t,i}function $(t,e){for(var n=e.depth,i=[],r=[],o=[],s=t.leftPoints,a=t.rightPoints,l=0,h=s.length;l<h;){var c=3*l,u=s[l],d=u[0],f=u[1],p=u[2];i[c]=d,i[c+1]=f,i[c+2]=n+p;var g=a[l],y=g[0],x=g[1],v=g[2],m=3*h+c;i[m]=y,i[m+1]=x,i[m+2]=n+v;var b=2*h*3+c;i[b]=d,i[b+1]=f,i[b+2]=p;var _=2*h*3+3*h+c;i[_]=y,i[_+1]=x,i[_+2]=v,l++}for(l=0,h=i.length;l<h;){var w=i[l],M=i[l+1];o.push(w,M),l+=3}for(l=0,h=s.length;l<h-1;){var O=l,A=l+1,j=O+h,S=A+h;r.push(O,j,A),r.push(j,S,A);var T=l+2*h,C=T+1,k=T+h,P=C+h;r.push(T,k,C),r.push(k,P,C),l++}t.index=r,t.points=i,t.uvs=o}function X(t,e){var n=t.points,i=t.index,r=t.leftPoints,o=t.rightPoints,s=t.uvs,a=e.depth,l=[r,o];function h(t,e){var r=n.length/3;n.push(t[0],t[1],a+t[2],e[0],e[1],a+e[2],t[0],t[1],t[2],e[0],e[1],e[2]);var o=r+2,l=r+3,h=r,c=r+1;i.push(o,h,l,h,c,l),D(s,n,o,l,h,c)}for(var c=0,u=l.length;c<u;c++){var d=l[c];c>0&&(d=(d=d.map((function(t){return t}))).reverse());for(var f=0,p=d.length-1;f<p;)h(d[f],d[f+1]),f++}for(var g=r.length,y=[o[0],r[0],r[g-1],o[g-1]],x=0;x<y.length;x+=2)h(y[x],y[x+1])}var tt={x:0,y:0},et={x:0,y:0};function nt(t,e){for(var n=0,i=e.lineWidth/2,r=[],o=[],s=[],a=t.length,l=0;l<a-1;){var h=t[l],c=t[l+1],u=c[1]-h[1],d=c[0]-h[0],f=0,p=G(Math.atan(u/d));if(n=p,0===l)f=p,f-=90;else{var g=t[l-1];tt.x=g[0]-h[0],tt.y=g[1]-h[1],et.x=c[0]-h[0],et.y=c[1]-h[1],f=p-rt(tt,et)/2}var y=it(Z(f),i,h),x=y[0],v=y[1];r.push(x,v),ot(x,h,c)?(o.push(x),s.push(v)):(o.push(v),s.push(x)),l++}var m=n,b=Z(m-=90),_=t[a-2],w=t[a-1],M=it(b,i,w),O=M[0],A=M[1];return r.push(O,A),ot(O,_,w)?(o.push(O),s.push(A)):(o.push(A),s.push(O)),{offsetPoints:r,leftPoints:o,rightPoints:s}}function it(t,e,n){var i=n[0],r=n[1],o=n[2]||0,s=[i+Math.cos(t)*e,r+Math.sin(t)*e,o],a=t+=Math.PI;return[s,[i+Math.cos(a)*e,r+Math.sin(a)*e,o]]}var rt=function(t,e){var n=t.x,i=t.y,r=e.x,o=e.y,s=n*r+i*o,a=n*o-i*r;return(Math.atan2(a,s)/Math.PI*180+360)%360};function ot(t,e,n){var i=e[0],r=e[1],o=n[0],s=n[1];return(r-s)*t[0]+(o-i)*t[1]+i*s-o*r>0}function st(t,e){void 0===e&&(e={}),e=Object.assign({},{radius:1,height:2,radialSegments:6},e);for(var n=Math.round(Math.max(4,e.radialSegments)),i=e,r=i.radius,o=i.height,s=360/n/360*Math.PI*2,a=n+1,l=new Float32Array(3*a*2),h=t[0],c=t[1],u=0,d=0,f=3*a,p=2*a,g=[],y=[],x=-1;x<n;x++){var v=s*x,m=Math.cos(v)*r+h,b=Math.sin(v)*r+c;l[u]=m,l[u+1]=b,l[u+2]=0,l[u+f]=m,l[u+1+f]=b,l[u+2+f]=o;var _=0,w=0;_=.5+m/r/2,w=.5+b/r/2,y[d]=_,y[d+1]=w,y[d+p]=_,y[d+1+p]=w,u+=3,d+=2,x>1&&g.push(0,x-1,x)}l[u-=3]=l[0],l[u+1]=l[1],l[u+2]=l[2];var M=l.length;l[M-3]=l[0],l[M-2]=l[1],l[M-1]=o;for(var O=g.length,A=0;A<O;A++){var j=g[A];g.push(j+a)}var S=new Float32Array(2*(3*a*2-6)),T=-1;u=2*a,d=0;for(var C=0,k=l.length/2;C<k-3;C+=3){var P=l[C],L=l[C+1],B=l[C+3],z=l[C+4];S[++T]=P,S[++T]=L,S[++T]=o,S[++T]=B,S[++T]=z,S[++T]=o,S[++T]=P,S[++T]=L,S[++T]=0,S[++T]=B,S[++T]=z,S[++T]=0;var I=u+2,E=u+3,U=u,F=u+1;g.push(U,I,F,I,E,F),u+=4;var R=d/a,G=(d+1)/a;y.push(R,o/r/2,G,o/r/2,R,0,G,0),d++}var Z=new Float32Array(l.length+S.length);Z.set(l,0),Z.set(S,l.length);var D=V(g,Z);return{points:l,indices:new Uint32Array(g),position:Z,normal:D,uv:new Float32Array(y)}}t.cylinder=st,t.expandLine=nt,t.extrudePolygons=H,t.extrudePolylines=Y,Object.defineProperty(t,"__esModule",{value:!0})}(e)}(0,L.exports);var B=r({__proto__:null,default:P(L.exports)},[L.exports]);function z(t,e,n={}){return void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]}function I(t,e,n={}){return void 0===n[t]&&(n[t]=e.altitudeToVector3(t,t).x),n[t]}function E(t=[]){let e=0,n=0;const i=t.length;for(let r=0;r<i;r++){const{coordinate:i,lnglat:s,lnglats:a,xy:l,xys:h}=t[r],c=i||s||a||l||h||t[r];let u,d;Array.isArray(c)?(u=c[0],d=c[1]):c instanceof o.Coordinate&&(u=c.x,d=c.y),e+=u,n+=d}return new o.Coordinate(e/i,n/i)}function U(t,e,n,i){if(void 0===e||"number"!=typeof e||0===e)return 0;let r;r=t instanceof s.BufferGeometry?t.attributes.position.array:Array.isArray(t)||t instanceof Float32Array?t:t.position;let o=0;if(r){i?(void 0===i[e]&&(i[e]=n.altitudeToVector3(e,e).x),o=i[e]):o=n.altitudeToVector3(e,e).x;const t=r.length;if(r[0]instanceof s.Vector3)for(let e=0;e<t;e++)r[e].z+=o;else for(let e=0;e<t;e+=3)r[e+2]+=o}return o}function F(t){const e=t.length;let n=0;for(let i=0;i<e;i++){const{count:e}=t[i].position;n+=e}return new Float32Array(3*n)}function V(t=[]){const e=t.length,n=new Float64Array(2*e);for(let i=0;i<e;i++){let e,r;const o=t[i];o.x?(e=o.x,r=o.y):(e=o[0],r=o[1]),n[2*i]=e,n[2*i+1]=r}return n.buffer}const R=new s.Color("#fff"),G=new s.Color("#fff");function Z(t,e,n,i){const{position:r,normal:o,uv:a,indices:h}=D(t,e,n,i),c=new Float32Array(r.length);c.fill(1,0,r.length);const u=new s.BufferGeometry;return l(u,"color",new s.BufferAttribute(c,3)),l(u,"normal",new s.BufferAttribute(o,3)),l(u,"position",new s.BufferAttribute(r,3)),l(u,"uv",new s.BufferAttribute(a,2)),u.setIndex(new s.BufferAttribute(h,1)),u}function D(t,e,n,i,r,o){const s=Q(t,n,i,r,!1);if(!s)return null;o?(null==o[e]&&(o[e]=n.altitudeToVector3(e,e).x),e=o[e]):e=n.altitudeToVector3(e,e).x;const{position:a,normal:l,uv:h,indices:c}=L.exports.extrudePolygons(s,{depth:e});return{position:a,normal:l,uv:h,indices:c}}function H(t,e,n,i){void 0===i&&(i=0);const r=t.attributes.position.array,o=r.length;let a;if(G.setStyle(e),R.setStyle(n),Array.isArray(i)){let t=0;for(let e=0,n=i.length;e<n;e++){const{count:n}=i[e].position;t+=3*n}a=new Float32Array(t)}else a=new Float32Array(r.length);if(Array.isArray(i))for(let t=0,e=i.length;t<e;t++){const{middleZ:e,start:n,end:o}=i[t].position;for(let t=n;t<o;t+=3){r[t+2]>e?(a[t]=R.r,a[t+1]=R.g,a[t+2]=R.b):(a[t]=G.r,a[t+1]=G.g,a[t+2]=G.b)}}else for(let t=0;t<o;t+=3){r[t+2]>i?(a[t]=R.r,a[t+1]=R.g,a[t+2]=R.b):(a[t]=G.r,a[t+1]=G.g,a[t+2]=G.b)}return l(t,"color",new s.BufferAttribute(a,3,!0)),a}function Q(t,e,n,i,r=!1){if(!t)return null;let s=[];if(t instanceof o.MultiPolygon)s=t.getGeometries().map((o=>W(o,e,n||t.getCenter(),i,r)));else if(t instanceof o.Polygon){const o=W(t,e,n||t.getCenter(),i,r);s.push(o)}else if(M(t))if(j(t)){const o=C(t);for(let a=0,l=o.length;a<l;a++)s.push(W(o[a],e,n||T(t),i,r))}else{const o=W(t,e,n||T(t),i,r);s.push(o)}return s}function W(t,e,n,i,r=!1){let s,a,l;if(M(t)){const e=S(t);s=e[0],a=e.slice(1,e.length),n=n||T(t)}else t instanceof o.Polygon&&(s=t.getShell(),a=t.getHoles(),n=n||t.getCenter());i=i||e.coordinateToVector3(n),l=r?e.coordinatiesToGLFloatArray(s,i).positons2d:e.coordinatiesToGLArray(s,i);const h=[r?l.buffer:l];if(a&&a.length>0)for(let t=0,n=a.length;t<n;t++){let n;n=r?e.coordinatiesToGLFloatArray(a[t],i).positons2d:e.coordinatiesToGLArray(a[t],i),h.push(r?n.buffer:n)}return h}function N(t){if(!t)return null;let e=[];if(t instanceof o.MultiPolygon)e=t.getGeometries().map((t=>q(t,!1)));else if(t instanceof o.Polygon){const n=q(t,!1);e.push(n)}else if(M(t))if(j(t)){const n=C(t);for(let t=0,i=n.length;t<i;t++)e.push(q(n[t],!0))}else{const n=q(t,!0);e.push(n)}return e}function q(t,e){let n,i;if(e){const e=S(t);n=e[0],i=e.slice(1,e.length)}else t instanceof o.Polygon&&(n=t.getShell(),i=t.getHoles());const r=[V(n)];if(i&&i.length>0)for(let t=0,e=i.length;t<e;t++){const e=V(i[t]);r.push(e)}return r}var K=Object.freeze({__proto__:null,getExtrudeGeometry:Z,getExtrudeGeometryParams:D,initVertexColors:H,getPolygonPositions:Q,getSinglePolygonPositions:W,getPolygonArrayBuffer:N,getSinglePolygonArrayBuffer:q});function J(t,e,n,i=!0){let r,a,l=[];if(Array.isArray(t)&&t[0]instanceof s.Vector3)l=t;else{Array.isArray(t)&&(t=new o.LineString(t));const s=0;let h,c;w(t)?(h=S(t),n||(c=T(t))):t instanceof o.LineString&&(h=t.getCoordinates(),n||(c=t.getCenter()));const u=e.coordinateToVector3(n||c);if(i)for(let t=0,n=h.length;t<n;t++){const n=h[t],i=e.coordinateToVector3(n,s).sub(u);l.push(i)}else{const t=e.coordinatiesToGLFloatArray(h,u);r=t.positions,a=t.positons2d}}if(!i)return{positions:r,positionsV:l,positions2d:a,arrayBuffer:a.buffer};a=new Float32Array(2*l.length),r=new Float32Array(3*l.length);for(let t=0,e=l.length;t<e;t++){const e=3*t,n=l[t];r[e]=n.x,r[e+1]=n.y,r[e+2]=n.z;const i=2*t;a[i]=n.x,a[i+1]=n.y}return{positions:r,positionsV:l,positions2d:a,arrayBuffer:a.buffer}}function Y(t,e,n,i){const r=[],o=[],s=[];let a,l;for(let n=0,h=t.length;n<h;n++){const h=t[n];for(let t=0,n=h.length;t<n;t++){const n=h[t],c=n.join(",").toString();a?(c!==a&&(l=e.coordinateToVector3(n,0).sub(i),r.push(l.x,l.y,l.z),o.push(l),s.push(n)),a=c):(s.push(n),a=c,l=e.coordinateToVector3(n,0).sub(i),r.push(l.x,l.y,l.z),o.push(l))}}return{positions:r,positionsV:o,lnglats:s}}function $(t){let e;const n=[];for(let i=0,r=t.length;i<r;i++){const r=t[i];for(let t=0,i=r.length;t<i;t++){const i=r[t],o=i.join(",").toString();e?(o!==e&&n.push(i),e=o):(n.push(i),e=o)}}return n}function X(t,e=1,n=1,i,r){const o=J(t,i,r).positionsV,s=[];for(let t=0,e=o.length;t<e;t++){const e=o[t];s.push([e.x,e.y])}const{indices:a,position:l,normal:h,uv:c}=L.exports.extrudePolylines([s],{lineWidth:e,depth:n});return{position:l,normal:h,indices:a,uv:c}}function tt(t){let e,n=[];return t instanceof o.MultiLineString?(n=t.getGeometries(),e=t.getCenter()):t instanceof o.LineString?(n.push(t),e=t.getCenter()):w(t)&&(e=T(t),j(t)?n=C(t):n.push(t)),{lineStrings:n,center:e}}function et(t){const e=new Float32Array(2*t.length-6);let n=0;for(let i=0,r=t.length/3;i<r;i++){const o=t[3*i],s=t[3*i+1],a=t[3*i+2];if(i>0&&i<r-1){const t=3*n;e[t]=o,e[t+1]=s,e[t+2]=a,n++}const l=3*n;e[l]=o,e[l+1]=s,e[l+2]=a,n++}return e}function nt(t){let e=0;const n=t.length;if(1===n)return t[0];for(let i=0;i<n;i++)e+=t[i].length;const i=new Float32Array(e);let r=0;for(let e=0;e<n;e++)i.set(t[e],r),r+=t[e].length;return i}function it(t){return t instanceof o.LineString?V(t.getCoordinates()):O(t)?V(t.geometry.coordinates):void 0}let rt;function ot(){return rt||(rt=new s.BufferGeometry,l(rt,"position",new s.BufferAttribute(new Float32Array(3),3))),rt}var st=Object.freeze({__proto__:null,getLinePosition:J,getExtrudeLineGeometry:function(t,e=1,n=1,i,r){const{indices:o,position:a,normal:h,uv:c}=X(t,e,n,i,r),u=new s.BufferGeometry;return l(u,"position",new s.BufferAttribute(a,3)),l(u,"normal",new s.BufferAttribute(h,3)),l(u,"uv",new s.BufferAttribute(c,2)),u.setIndex(new s.BufferAttribute(o,1)),u},getChunkLinesPosition:Y,mergeChunkLineCoordinates:$,getExtrudeLineParams:X,LineStringSplit:tt,setLineSegmentPosition:function(t,e){for(let n=0,i=e.length;n<i;n++){const r=e[n];n>0&&n<i-1&&t.push(r.x,r.y,r.z),t.push(r.x,r.y,r.z)}},getLineSegmentPosition:et,mergeLinePositions:nt,getLineArrayBuffer:it,getDefaultLineGeometry:ot});let at;var lt;function ht(){return o.worker||console.error("maptalks.worker is not defined,You can't use ThreeVectorTileLayer"),!lt&&at&&(lt=new at("__maptalks.three__")),lt}function ct(t,e,n={}){return void 0!==t&&"number"==typeof t&&0!==t?(void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]):0}function ut(t,e,n={}){return void 0!==t&&"number"==typeof t&&0!==t?(void 0===n[t]&&(n[t]=e.altitudeToVector3(t,t).x),n[t]):0}function dt(t,e,n,i,r=[]){const o=n.isMercator();let s,a,l;if(o){const t=n.getMap();s=t.getGLRes(),a=t.getSpatialReference().getTransformation().matrix}e&&(l=n.coordinateToVector3(e));const h=[],c=[],u={},d={},f=t.length;for(let s=0;s<f;s++){const a=t[s],f=r[s]?r[s]:O(i[s])?i[s].properties:i[s].getProperties()||{};e||(l=n.coordinateToVector3(f.center));let p=f.width||1,g=f.height||1,y=f.bottomHeight||0;p=ct(p,n,u),g=ut(g,n,d),y=ut(y,n,d);const x=[];for(let t=0,i=a.length;t<i;t++){const i=a[t];let r;r=o?it(i):J(i,n,e,!1).arrayBuffer,c.push(r),x.push(r)}const v={id:f.id,data:x,height:g,width:p,bottomHeight:y};o&&(v.center=[l.x,l.y]),h.push(v)}return{datas:h,transfer:c,glRes:s,matrix:a,center:o?[l.x,l.y]:null}}function ft(t,e,n,i,r=[]){const o=n.isMercator();let s,a,l;if(o){const t=n.getMap();s=t.getGLRes(),a=t.getSpatialReference().getTransformation().matrix}e&&(l=n.coordinateToVector3(e));const h=[],c=[],u={},d=t.length;for(let s=0;s<d;s++){const a=t[s],d=r[s]?r[s]:O(i[s])?i[s].properties:i[s].getProperties()||{};e||(l=n.coordinateToVector3(d.center));let f=d.bottomHeight||0;f=ut(f,n,u);const p=[];for(let t=0,i=a.length;t<i;t++){const i=a[t];if(o){const t=it(i);p.push(t),p.push(t)}else{const t=J(i,n,e,!1).arrayBuffer;c.push(t),p.push(t)}}const g={id:d.id,data:p,bottomHeight:f};o&&(g.center=[l.x,l.y]),h.push(g)}return{datas:h,transfer:c,glRes:s,matrix:a,center:o?[l.x,l.y]:null}}function pt(t){return t.map((t=>t.data))}function gt(t){return t.map((t=>t.option||t.baseObject.getOptions()))}o.worker&&(at=class extends o.worker.Actor{test(t,e){this.send(t,null,e)}pushQueue(t={}){const{type:e,data:n,callback:i,layer:r,key:o,center:s,lineStrings:a,options:l,id:h}=t;let c;e.indexOf("ExtrudePolygon")>-1?c=function(t=[],e,n,i=[]){const r=n.isMercator();let o,s,a;if(r){const t=n.getMap();o=t.getGLRes(),s=t.getSpatialReference().getTransformation().matrix}e&&(a=n.coordinateToVector3(e));const l=t.length,h=[],c=[],u={};for(let o=0;o<l;o++){const s=t[o],l=s,d=i[o]?i[o]:M(l)?l.properties:l.getProperties()||{};let f;e||(a=n.coordinateToVector3(d.center)),f=r?N(s):Q(s,n,d.center||e,a,!0);for(let t=0,e=f.length;t<e;t++){const e=f[t];for(let t=0,n=e.length;t<n;t++)c.push(e[t])}let p=d.height||1,g=d.bottomHeight||0;p=ut(p,n,u),g=ut(g,n,u);const y={id:d.id,data:f,height:p,bottomHeight:g};r&&(y.center=[a.x,a.y]),h.push(y),l._properties&&delete l._properties}return{datas:h,transfer:c,glRes:o,matrix:s,center:r?[a.x,a.y]:null}}(n,s,r,l):"ExtrudeLines"===e?c=dt(n,s,r,a):"Point"===e||("Line"===e||"FatLine"===e?c=ft(n,s,r,a,l):"Lines"===e||"FatLines"===e?c=ft(n,s,r,a):"ExtrudeLine"===e?c=dt(n,s,r,a,l):"Bar"!==e&&"Bars"!==e||(c=function(t){const e=t.length,n=new Float32Array(7*e);let i=0;for(let r=0;r<e;r++){let{center:e,radialSegments:o,radius:s,height:a,altitude:l,id:h}=t[r];e=e||[0,0],n[i]=e[0],n[i+1]=e[1],n[i+2]=o||6,n[i+3]=s||1,n[i+4]=a,n[i+5]=l||0,n[i+6]=h,i+=7}const r=n.buffer;return{datas:r,transfer:[r]}}(n))),c?this.send({type:e,datas:c.datas,glRes:c.glRes,matrix:c.matrix,center:c.center},c.transfer,(function(t,e){t&&console.error(t),e.key=o,e.id=h,i(e)})):console.error(`not support '${e}' worker`)}});class yt{constructor(){this.queueMap={},this.tempQueue=[],this.time=this.getCurrentTime(),this.deQueueCount=5,this.resultQueue=[]}getActor(){return ht()}getCurrentTime(){return o.Util.now()}loop(){this.deQueue()}push(t){return this.tempQueue.push(t),t.id&&(this.queueMap[t.id]=t),this}reset(){return this.time=this.getCurrentTime(),this.tempQueue=[],this}pushResult(t){if(t)return Array.isArray(t)||(t=[t]),t.forEach((t=>{this.resultQueue.push(t)})),this}deQueue(){if(!this.resultQueue.length)return this;const t=this.deQueueCount;return(this.resultQueue.slice(0,t)||[]).forEach((t=>{const{id:e}=t;if(this.queueMap[e]){const{baseObject:n}=this.queueMap[e];n&&n._workerLoad&&n._workerLoad(t),delete this.queueMap[e]}})),this.resultQueue.splice(0,t),this}}const xt=new class extends yt{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){ht().pushQueue({type:"ExtrudePolygon",layer:this.tempQueue[0].layer,data:pt(this.tempQueue),options:gt(this.tempQueue),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},vt=new class extends yt{loop(){if(this.tempQueue.length){const t=ht();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"ExtrudePolygons",layer:e.layer,data:e.data,key:e.key,center:e.center,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},mt=new class extends yt{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){ht().pushQueue({type:"ExtrudeLine",layer:this.tempQueue[0].layer,data:pt(this.tempQueue),options:gt(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},bt=new class extends yt{loop(){if(this.tempQueue.length){const t=ht();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"ExtrudeLines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},_t=new class extends yt{constructor(){super(),this.deQueueCount=200}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){ht().pushQueue({type:"Line",layer:this.tempQueue[0].layer,data:pt(this.tempQueue),options:gt(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},wt=new class extends yt{loop(){if(this.tempQueue.length){const t=ht();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"Lines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},Mt=new class extends yt{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){ht().pushQueue({type:"FatLine",layer:this.tempQueue[0].layer,data:pt(this.tempQueue),options:gt(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Ot=new class extends yt{loop(){if(this.tempQueue.length){const t=ht();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"FatLines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},At=new class extends yt{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){ht().pushQueue({type:"Bar",layer:this.tempQueue[0].layer,data:pt(this.tempQueue),options:gt(this.tempQueue),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},jt=new class extends yt{constructor(){super(),this.deQueueCount=1}loop(){if(this.tempQueue.length){const t=ht();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"Bars",layer:e.layer,data:e.data,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},St={isRunning:!1,tasks:[],addTask:t=>{t&&St.tasks.push(t)},removeTask:t=>{St.tasks.splice(St.tasks.indexOf(t),1)},loop(){xt.loop(),vt.loop(),mt.loop(),bt.loop(),_t.loop(),wt.loop(),Mt.loop(),Ot.loop(),At.loop(),jt.loop(),St.tasks.forEach((t=>{t&&t.loop&&t.loop()})),o.Util.requestAnimFrame(St.loop)},star(){St.isRunning||(St.isRunning=!0,St.loop())}};function Tt(t){const{position:e,normal:n,uv:i,indices:r}=Ct(t),o=new s.BufferGeometry,a=new Float32Array(e.length);return a.fill(1,0,e.length),l(o,"color",new s.BufferAttribute(a,3)),l(o,"normal",new s.BufferAttribute(n,3)),l(o,"position",new s.BufferAttribute(e,3)),i&&i.length&&l(o,"uv",new s.BufferAttribute(i,2)),o.setIndex(new s.BufferAttribute(r,1)),o}function Ct(t){const e={},n={};for(let i=0;i<t.length;++i){const r=t[i];for(const t in r)void 0===e[t]&&(e[t]=[],n[t]=0),e[t].push(r[t]),n[t]+=r[t].length}const i={};let r=0;const o=new Uint32Array(n.indices);for(const t in e)if("indices"===t){const n=e[t];let i=0;for(let t=0,s=n.length;t<s;t++){const s=n[t];for(let t=0,e=s.length;t<e;t++)o[i]=s[t]+r,i++;r+=e.position[t].length/3}}else{const r=kt(e[t],n[t]);if(!r)return null;i[t]=r}return i.indices=o,i}function kt(t,e){const n=new Float32Array(e);let i=0;for(let e=0;e<t.length;++e)n.set(t[e],i),i+=t[e].length;return n}function Pt(t){const{position:e,normal:n,uv:i,indices:r}=t,o=new s.BufferGeometry;return l(o,"normal",new s.BufferAttribute(new Float32Array(n),3)),l(o,"position",new s.BufferAttribute(new Float32Array(e),3)),l(o,"uv",new s.BufferAttribute(new Float32Array(i),2)),o.setIndex(new s.BufferAttribute(new Uint32Array(r),1)),o}function Lt(t){const e=new s.BufferGeometry;return l(e,"normal",t.getAttribute("normal")),l(e,"position",t.getAttribute("position").clone()),e.setIndex(t.getIndex()),e}let Bt;function zt(){if(!Bt){const t=1e-6;Bt=new s.BoxBufferGeometry(t,t,t)}return Bt}zt();var It=Object.freeze({__proto__:null,mergeBufferGeometries:Tt,mergeBufferGeometriesAttribute:Ct,generateBufferGeometry:Pt,generatePickBufferGeometry:Lt,getDefaultBufferGeometry:zt});const Et=new s.BoxBufferGeometry(1,1,1);Et.translate(0,0,.5);const Ut=new s.Color("#fff"),Ft=new s.Color("#fff");function Vt(t){const e=Object.assign({},t);return e._radius&&(e.radius=e._radius),function(t){const{position:e,normal:n,uv:i,indices:r}=L.exports.cylinder(t.center||[0,0],t),o=new s.BufferGeometry;return l(o,"normal",new s.BufferAttribute(n,3)),l(o,"position",new s.BufferAttribute(e,3)),l(o,"uv",new s.BufferAttribute(i,2)),o.setIndex(new s.BufferAttribute(r,1)),o}(e)}function Rt(t,e,n,i="y",r=0){let o=0;"y"===i?o=1:"z"===i&&(o=2);const a=t.attributes.position.array,h=a.length;Ft.setStyle(e),Ut.setStyle(n);const c=new Float32Array(h);if(Array.isArray(r))for(let t=0,e=r.length;t<e;t++){const{middleZ:e,start:n,end:i}=r[t].position;for(let t=n;t<i;t+=3){a[t+2]>e?(c[t]=Ut.r,c[t+1]=Ut.g,c[t+2]=Ut.b):(c[t]=Ft.r,c[t+1]=Ft.g,c[t+2]=Ft.b)}}else for(let t=0;t<h;t+=3){a[t+o]>r?(c[t]=Ut.r,c[t+1]=Ut.g,c[t+2]=Ut.b):(c[t]=Ft.r,c[t+1]=Ft.g,c[t+2]=Ft.b)}return l(t,"color",new s.BufferAttribute(c,3,!0)),c}function Gt(t){const e=[],n=t.length;let i=0;for(let e=0;e<n;e++){const{color:n}=t[e].attributes;n&&(i+=n.array.length)}const r=new Float32Array(i);let o=0;for(let n=0,i=t.length;n<i;n++){const{color:i,normal:s,position:a,uv:l}=t[n].attributes,h=t[n].index;i&&(r.set(i.array,o),o+=i.array.length),e.push({normal:s.array,uv:l.array,position:a.array,indices:h.array})}const a=Tt(e);r.length&&l(a,"color",new s.BufferAttribute(r,3,!0));for(let e=0,n=t.length;e<n;e++)t[e].dispose();return a}function Zt(){return Et}const Dt={radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61",heightEnable:!0};class Ht extends m{constructor(t,e,n,i){e=o.Util.extend({},Dt,e,{layer:i,coordinate:t}),super(),this._initOptions(e);const{height:r,radius:s,topColor:a,bottomColor:l,altitude:c,asynchronous:u}=e;let d;if(e.height=i.altitudeToVector3(r,r).x,e.radius=i.distanceToVector3(s,s).x,u){d=zt();const t=o.Util.GUID();this.getOptions().id=t,At.push({data:{radius:e.radius,height:e.height,radialSegments:e.radialSegments,id:t},layer:i,id:t,baseObject:this})}else d=Vt(e),a&&(Rt(d,l,a,"z",e.height/2),n.vertexColors=h());this._createMesh(d,n);const f=i.altitudeToVector3(c,c).x,p=i.coordinateToVector3(t,f);this.getObject3d().position.copy(p),this.type="Bar"}_workerLoad(t){const e=Pt(t),{topColor:n,bottomColor:i,height:r}=this.getOptions(),o=this.getObject3d(),s=o.material;if(n){Rt(e,i,n,"z",this.getLayer().altitudeToVector3(r,r).x/2),s.vertexColors=h()}o.geometry=e,o.material.needsUpdate=!0,this._fire("workerload",{target:this})}}function Qt(t){const e=[];return t&&t.length&&t.forEach((t=>{t=t instanceof s.Color?t:new s.Color(t),e.push(t.r,t.g,t.b)})),e}const Wt={altitude:0,bottomHeight:0,colors:null};class Nt extends m{constructor(t,e,n,i){e=o.Util.extend({},Wt,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{lineStrings:r,center:a}=tt(t),{asynchronous:c}=e;let u;if(c){u=ot();const n=o.Util.GUID();this.getOptions().id=n,this.getOptions().center=a,_t.push({id:n,data:r,layer:i,key:e.key,lineString:t,baseObject:this})}else{const t=[];for(let e=0,n=r.length;e<n;e++){const n=r[e],{positions:o}=J(n,i,a,!1);t.push(et(o))}const o=nt(t);u=new s.BufferGeometry,l(u,"position",new s.BufferAttribute(o,3)),U(u,e.bottomHeight,i);const c=Qt(e.colors);c&&c.length&&(l(u,"color",new s.Float32BufferAttribute(c,3)),n.vertexColors=h())}this._createLineSegments(u,n);const{altitude:d}=e,f=i.altitudeToVector3(d,d).x,p=i.coordinateToVector3(a,f);this.getObject3d().position.copy(p),this.type="Line"}_workerLoad(t){const e=new s.BufferGeometry;l(e,"position",new s.BufferAttribute(new Float32Array(t.position),3));const n=Qt(this.getOptions().colors),i=this.getObject3d(),r=i.material;n&&n.length&&(l(e,"color",new s.Float32BufferAttribute(n,3)),r.vertexColors=h()),this._computeLineDistances(e),i.geometry=e,i.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const qt={bottomHeight:0,width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61",heightEnable:!0};class Kt extends m{constructor(t,e,n,i){e=o.Util.extend({},qt,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{height:r,width:s,bottomColor:a,topColor:l,bottomHeight:c,altitude:u,asynchronous:d}=e,f=i.altitudeToVector3(r,r).x,p=i.distanceToVector3(s,s).x,{lineStrings:g,center:y}=tt(t);let x;if(d){x=zt();const e=o.Util.GUID();this.getOptions().id=e,this.getOptions().center=y,mt.push({id:e,data:g,layer:i,center:y,lineString:t,baseObject:this})}else{const t=[];let e=0;const r={};for(let n=0,o=g.length;n<o;n++){const o=X(g[n],p,f,i,y);e=U(o,c,i,r),t.push(o)}x=Tt(t),l&&(H(x,a,l,e+f/2),n.vertexColors=h())}this._createMesh(x,n);const v=i.altitudeToVector3(u,u).x,m=i.coordinateToVector3(y,v);this.getObject3d().position.copy(m),this.type="ExtrudeLine"}_workerLoad(t){const e=Pt(t),{topColor:n,bottomColor:i,bottomHeight:r,height:o}=this.getOptions(),s=this.getObject3d(),a=s.material;if(n){const t=this.getLayer();H(e,i,n,t.altitudeToVector3(r,r).x+t.altitudeToVector3(o,o).x/2),a.vertexColors=h()}s.geometry=e,s.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const Jt={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61",heightEnable:!0};class Yt extends m{constructor(t,e,n,i){e=o.Util.extend({},Jt,e,{layer:i,polygon:t}),super(),this._initOptions(e);const{height:r,topColor:s,bottomColor:a,altitude:l,bottomHeight:c,asynchronous:u}=e;let d;const f=M(t)?T(t):t.getCenter();if(u){d=zt();const e=o.Util.GUID();this.getOptions().id=e,this.getOptions().center=f,xt.push({data:t,layer:i,id:e,baseObject:this})}else{d=Z(t,r,i);const e=U(d,c,i);if(s){H(d,a,s,e+i.altitudeToVector3(r,r).x/2),n.vertexColors=h()}}this._createMesh(d,n);const p=i.altitudeToVector3(l,l).x,g=i.coordinateToVector3(f,p);this.getObject3d().position.copy(g),this.type="ExtrudePolygon"}_workerLoad(t){const e=Pt(t),{topColor:n,bottomColor:i,bottomHeight:r,height:o}=this.getOptions(),s=this.getObject3d(),a=s.material;if(n){const t=this.getLayer();H(e,i,n,t.altitudeToVector3(r,r).x+t.altitudeToVector3(o,o).x/2),a.vertexColors=h()}s.geometry=e,s.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const $t={altitude:0,coordinate:null};class Xt extends m{constructor(t,e={},n){e.coordinate||(console.warn("coordinate is null,it is important to locate the model"),e.coordinate=n.getMap().getCenter()),e=o.Util.extend({},$t,e,{layer:n,model:t}),super(),this._initOptions(e),this._createGroup(),this.getObject3d().add(t);const{altitude:i,coordinate:r}=e,s=n.altitudeToVector3(i,i).x,a=n.coordinateToVector3(r,s);this.getObject3d().position.copy(a),this.type="Model"}}const te=Math.PI/180;function ee(t){return t.getCoordinates().map((t=>t.toArray()))}function ne(t){return t*te}function ie(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());let n=ne(t[1]);const i=ne(e[1]),r=n-i,o=ne(t[0])-ne(e[0]);return n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(n)*Math.cos(i)*Math.pow(Math.sin(o/2),2))),n*=6378137,Math.round(1e5*n)/1e5}function re(t,e){const{len:n,c1:i,c2:r}=t,o=r[0]-i[0],s=r[1]-i[1],a=e/n;return[i[0]+a*o,i[1]+a*s]}function oe(t,e=10){e=Math.max(e,.1),Array.isArray(t)||(t=ee(t));const n=t.length;let i=[],r=0;for(let e=0;e<n-1;e++){const n=ie(t[e],t[e+1]),o=Math.floor(n);i.push({c1:t[e],len:o,c2:t[e+1]}),r+=o}if(r<=e){return i.map((t=>[t.c1,t.c2]))}if(1===i.length&&i[0].len<=e)return[[i[0].c1,i[0].c2]];const o=i.length;let s,a=0,l=0;const h=[];let c=[i[0].c1];for(;a<o;){const{len:t,c2:n}=i[a];if(l+=t,l<e&&(c.push(n),a===o-1&&h.push(c),a++),l===e&&(c.push(n),l=0,h.push(c),c=[n],a++),l>e){const n=t-l+e;s=re(i[a],n),c.push(s),h.push(c),l=0,i[a].c1=s,i[a].len=t-n,c=[],c.push(s)}}return h}var se=Object.freeze({__proto__:null,distance:ie,lineLength:function(t){let e=t;Array.isArray(t)||(e=ee(t));let n=0;for(let t=0,i=e.length;t<i-1;t++)n+=ie(e[t],e[t+1]);return n},lineSlice:oe});const ae=1e3;const le={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1,heightEnable:!0};class he extends m{constructor(t,e,n,i){e=o.Util.extend({},le,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{width:r,height:a,altitude:h,speed:c,chunkLength:u,trail:d}=e;let f,p;w(t)?(f=T(t),p=S(t)):(f=t.getCenter(),p=t);const g=oe(p,u),y=i.coordinateToVector3(f),x=new s.BufferGeometry,v=new Float32Array(3e3),m=new Float32Array(3e3),b=new Uint16Array(ae);l(x,"position",new s.BufferAttribute(v,3)),l(x,"normal",new s.BufferAttribute(m,3)),x.setIndex(new s.BufferAttribute(b,1));const _=i.distanceToVector3(r,r).x,M=i.altitudeToVector3(a,a).x;this._createMesh(x,n);const O=i.altitudeToVector3(h,h).x,A=i.coordinateToVector3(f,O);this.getObject3d().position.copy(A),this._params={index:0,chunkLines:g,geometries:[],layer:i,trail:Math.max(1,d),lineWidth:_,depth:M,speed:Math.min(1,c),idx:0,loaded:!0,center:f,centerPt:y,workerInitCount:0},this._init(this._params),this.type="ExtrudeLineTrail"}_init(t){const{layer:e,trail:n,lineWidth:i,depth:r,chunkLines:s,positionMap:a,centerPt:l,center:h}=t,c=s.length,u=[];if(this.options.asynchronous){t.loaded=!1;const i=o.Util.GUID();for(let t=0;t<c;t++){const r={type:"Feature",geometry:{type:"LineString",coordinates:$(s.slice(t,t+n))}},a=`${i}-${t}`,l=o.Util.extend({},this.options);l.id=a,l.center=h,mt.push({id:a,data:[r],layer:e,center:h,lineString:r,baseObject:this,option:l})}}else for(let t=0;t<c;t++){const o=Y(s.slice(t,t+n),e,0,l).positionsV;u.push(X(o,i,r,e))}}_animation(){const{index:t,geometries:e,speed:n,idx:i,chunkLines:r,trail:o,lineWidth:s,depth:a,loaded:l,layer:h,positionMap:c,centerPt:u}=this._params;if(!l)return;const d=Math.round(t);if(d>i){this._params.idx++;let t=e[d];if(!t){t=X(Y(r.slice(d,d+o),h,0,u).positionsV,s,a,h),e[d]=t}const n=this.getObject3d();!function(t,e,n,i){const r=e.length;t.attributes.normal.count=r,t.attributes.position.count=r;const o=t.attributes.position.array,s=t.attributes.normal.array;for(let t=0;t<r;t++)o[t]=e[t],s[t]=n[t];t.index.count=i.length;for(let e=0,n=i.length;e<n;e++)t.index.array[e]=i[e]}(n.geometry,t.position,t.normal,t.indices),n.geometry.attributes.position.needsUpdate=!0,n.geometry.attributes.normal.needsUpdate=!0,n.geometry.index.needsUpdate=!0}t>=r.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=n}_workerLoad(t){if(!t)return this;const{id:e,indices:n,position:i,normal:r,uv:s}=t;if(!(e&&n&&i&&r&&s))return;let a=e.split("-")[1];if(a=parseInt(a),o.Util.isNumber(a)){this._params.geometries[a]={indices:new Uint32Array(n),position:new Float32Array(i),uv:new Float32Array(s),normal:new Float32Array(r)},this._params.workerInitCount++}this._params.workerInitCount===this._params.chunkLines.length&&(this._params.loaded=!0,this._fire("workerload",{target:this}))}}const ce=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),ue=new s.MeshBasicMaterial;ue.vertexColors=h();const de=t=>class extends t{_initBaseObjectsEvent(t){if(t&&Array.isArray(t)&&t.length)for(let e=0,n=t.length;e<n;e++){const n=t[e];this._proxyEvent(n)}return this}_proxyEvent(t){t.on("add",(t=>{this._showGeometry(t.target,!0)})),t.on("remove",(t=>{this._showGeometry(t.target,!1)})),t.on("mouseout",(t=>{this._mouseover=!1,this.fire("mouseout",Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))})),t.on(ce,(t=>{this.fire(t.type,Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))}))}_getHideGeometryIndex(t){const e=[];let n=0;for(let i=0,r=this._geometriesAttributes.length;i<r;i++)!0===this._geometriesAttributes[i].hide&&(e.push(i),n+=this._geometriesAttributes[i][t].count);return{indexs:e,count:n}}_updateAttribute(t,e){const{indexs:n}=this._getHideGeometryIndex(e),i=this._geometryCache.attributes[e].array,r=i.length;for(let e=0;e<r;e++)t.array[e]=i[e];let o=NaN;this.getObject3d()instanceof s.LineSegments&&(o=0);for(let i=0;i<n.length;i++){const r=n[i],{start:s,end:a}=this._geometriesAttributes[r][e];for(let e=s;e<a;e++)t.array[e]=o}return this}_showGeometry(t,e){let n;if(t&&(n=t.getOptions().index),null!=n){const t=this._geometriesAttributes[n],{hide:i}=t;if(i===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.position,"position"),r.attributes.position.needsUpdate=!0,this.isHide=e}return this}getSelectMesh(){const t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}}_getIndex(t){return null==t&&(t=this.faceIndex||this.index),t}_init(){const t=this.getLayer().getPick();this.on("add",(()=>{t.add(this.pickObject3d)})),this.on("remove",(()=>{t.remove(this.pickObject3d)}))}_setPickObject3d(){if(!this._colorMap)return;const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:n}=this,i=n.length,r=F(n);let o=0;for(let t=0;t<i;t++){const i=e.getColor(),s=i.getHex();this._colorMap[s]=t;const{count:a}=n[t].position;this._datas[t].colorIndex=s;for(let t=0;t<a;t++)r[o]=i.r,r[o+1]=i.g,r[o+2]=i.b,o+=3}l(t,"color",new s.BufferAttribute(r,3,!0));const a=e.getColor().getHex(),h=new s.Mesh(t,ue);h.position.copy(this.getObject3d().position),h._colorIndex=a,this.setPickObject3d(h)}},fe={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"},pe=new o.Coordinate(0,0);class ge extends(de(m)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const r=t.length;0===r&&console.error("polygons is empty");let s=1/0,a=1/0,l=-1/0,c=-1/0;for(let e=0;e<r;e++){const n=t[e],i=n.getCenter?n.getCenter():T(n,pe);let r,h;Array.isArray(i)?(r=i[0],h=i[1]):i instanceof o.Coordinate&&(r=i.x,h=i.y),s=Math.min(s,r),a=Math.min(a,h),l=Math.max(l,r),c=Math.max(c,h)}const u=new o.Coordinate((s+l)/2,(a+c)/2);e=o.Util.extend({},fe,e,{layer:i,polygons:t,coordinate:u});const{topColor:d,bottomColor:f,altitude:p,asynchronous:g}=e;let y;const x=[],v=[];if(super(),g)y=zt(),vt.push({id:o.Util.GUID(),layer:i,key:e.key,center:u,data:t,baseObject:this});else{const e=i.coordinateToVector3(u),o=[];let s=0;const a={};for(let n=0;n<r;n++){const r=t[n],l=M(r)?r.properties:r.getProperties()||{},h=l.height||1,c=l.bottomHeight||0,d=D(r,h,i,u,e,a);o.push(d);const f=U(d,c,i,a),{position:p,normal:g,uv:y,indices:x}=d;x.length;const m=p.length/3;g.length,y.length,v[n]={position:{middleZ:f+a[h]/2,count:m,start:s,end:s+3*m},hide:!1},s+=3*m}y=Tt(o),d&&(H(y,f,d,v),n.vertexColors=h())}this._initOptions(e),this._createMesh(y,n);const m=i.altitudeToVector3(p,p).x,b=i.coordinateToVector3(u,m);this.getObject3d().position.copy(b),this._baseObjects=x,this._datas=t,this._geometriesAttributes=v,this.faceIndex=null,this._geometryCache=Lt(y),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(x),g||(this._setPickObject3d(),this._init()),this.type="ExtrudePolygons"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,M(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new Yt(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=Pt(t);this._geometryCache=Lt(n);const{topColor:i,bottomColor:r}=this.getOptions(),o=this.getObject3d(),s=o.material;if(i&&(H(n,r,i,e),s.vertexColors=h()),o.geometry=n,o.material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}function ye(t,e,n){const i=t.project(n),r=e.width/2,o=e.height/2;return{x:Math.round(i.x*r+r),y:Math.round(-i.y*o+o)}}var xe=Object.freeze({__proto__:null,vectors2Pixel:function(t,e,n,i=0,r){return t[0]instanceof s.Vector3||(t=function(t,e=0,n){const i=[],r={};for(let o=0,a=t.length;o<a;o+=3){let a=t[o],l=t[o+1],h=t[o+2];e>0&&(h+=I(e,n,r)),i.push(new s.Vector3(a,l,h))}return i}(t,i,r)),t.map((t=>ye(t,e,n)))},vector2Pixel:ye});const ve={altitude:0,height:0,color:null},me=new s.Vector3;class be extends m{constructor(t,e,n,i){e=o.Util.extend({},ve,e,{layer:i,coordinate:t}),super();let{height:r,altitude:a,color:h,size:c}=e;const u=[],d=[];h&&(h=h instanceof s.Color?h:new s.Color(h),d.push(h.r,h.g,h.b));const f=i.altitudeToVector3(r,r).x,p=i.coordinateToVector3(t,f);u.push(0,0,p.z);const g=new s.BufferGeometry;l(g,"position",new s.Float32BufferAttribute(u,3,!0)),d.length&&l(g,"color",new s.Float32BufferAttribute(d,3,!0)),void 0!==c&&l(g,"size",new s.Float32BufferAttribute([c],1,!0)),e.positions=p,this._initOptions(e),this._createPoints(g,n);const y=i.altitudeToVector3(a,a).x,x=new s.Vector3(p.x,p.y,y);this.getObject3d().position.copy(x),this.type="Point"}identify(t){const e=this.getLayer(),n=this.getMap().getSize(),i=this.getLayer().getCamera(),r=this.getOptions().positions,o=this.getOptions().altitude;let s=this.getObject3d().material.size;void 0===s&&(s=this.options.size||1);const a=this.getMap().coordToContainerPoint(t),l=e.altitudeToVector3(o,o).x;me.x=r.x,me.y=r.y,me.z=r.z+l;const h=ye(me,n,i);return Math.sqrt(Math.pow(a.x-h.x,2)+Math.pow(a.y-h.y,2))<=s/2}}function _e(t,e){const{minx:n,miny:i,maxx:r,maxy:o}=t,[s,a]=e;return n<=s&&s<=r&&i<=a&&a<=o}class we{constructor(t,e,n,i){this.minlng=t,this.minlat=e,this.maxlng=n,this.maxlat=i,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}updateBBoxPixel(t){let e=1/0,n=1/0,i=-1/0,r=-1/0;const{minlng:s,minlat:a,maxlng:l,maxlat:h}=this;return[[s,a],[s,h],[l,a],[l,h]].map((t=>new o.Coordinate(t))).map((e=>t.coordToContainerPoint(e))).forEach((t=>{e=Math.min(e,t.x),n=Math.min(n,t.y),i=Math.max(i,t.x),r=Math.max(r,t.y)})),this.minx=e,this.miny=n,this.maxx=i,this.maxy=r,this}containsCoordinate(t){let e,n;Array.isArray(t)?(e=t[0],n=t[1]):t instanceof o.Coordinate&&(e=t.x,n=t.y);const{minlng:i,minlat:r,maxlng:s,maxlat:a}=this;return i<=e&&e<=s&&r<=n&&n<=a}isRecCross(t,e){const{x:n,y:i}=t,r={minx:n-e/2,miny:i-e/2,maxx:n+e/2,maxy:i+e/2},{minx:o,miny:s,maxx:a,maxy:l}=r;return!!(_e(this,[o,s])||_e(this,[o,l])||_e(this,[a,s])||_e(this,[a,l])||_e(r,[this.minx,this.miny])||_e(r,[this.minx,this.maxy])||_e(r,[this.maxx,this.miny])||_e(r,[this.maxx,this.maxy]))}static initGrids(t,e,n,i){const r=[],o=(n-t)/30,s=(i-e)/30;let a=t,l=e;for(let n=0;n<30;n++){a=t+n*o;for(let t=0;t<30;t++){l=e+t*s;const i=new we(a,l,a+o,l+s);i.key=t+"-"+n,r.push(i)}}return{grids:r,averageX:o,averageY:s,ROWS:30,COLS:30}}}const Me={altitude:0},Oe=new s.Vector3;function Ae(t,e){const n=Math.pow(10,e);return Math.round(t*n)/n}class je extends(de(m)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]),e=o.Util.extend({},Me,e,{layer:i,points:t});let r=1/0,a=1/0,h=-1/0,c=-1/0;for(let e=0,n=t.length;e<n;e++){const{coordinate:n}=t[e];let i,s;Array.isArray(n)?(i=n[0],s=n[1]):n instanceof o.Coordinate&&(i=n.x,s=n.y),t[e].coords=[i,s],r=Math.min(r,i),a=Math.min(a,s),h=Math.max(h,i),c=Math.max(c,s)}const u=i.coordinateToVector3([(r+h)/2,(a+c)/2]),{grids:d,averageX:f,averageY:p,ROWS:g,COLS:y}=we.initGrids(r,a,h,c);d.length;const x=new Float32Array(3*t.length),v=[],m=new Float32Array(3*t.length),b=new Float32Array(t.length),_=[],w=[],M={};let O=0,A=!1,j=!1;const S=new s.Vector3(0,0,0);for(let e=0,n=t.length;e<n;e++){let{coordinate:n,height:o,color:l,size:h,coords:c}=t[e];const y=3*e;l&&(A=!0,l=l instanceof s.Color?l:new s.Color(l),m[y]=l.r,m[y+1]=l.g,m[y+2]=l.b),h&&(j=!0,b[e]=h,O=Math.max(O,h));const _=I(o,i,M),T=i.coordinateToVector3(n,_);S.x=T.x,S.y=T.y,S.z=T.z,S.sub(u),x[y]=S.x,x[y+1]=S.y,x[y+2]=S.z,v.push(T),w[e]={position:{count:1,start:3*e,end:3*e+3},hide:!1};let C=Ae((c[1]-a)/p,4),k=Ae((c[0]-r)/f,4);C-=1,k-=1,C=Math.max(0,C),k=Math.max(0,k),C=Math.ceil(C),k=Math.ceil(k);const P=k*g+C;d[P]&&(d[P].positions.push(T),d[P].indexs.push(e))}const T=new s.BufferGeometry;l(T,"position",new s.BufferAttribute(x,3,!0)),A&&l(T,"color",new s.BufferAttribute(m,3,!0)),j&&l(T,"size",new s.BufferAttribute(b,1,!0)),e.positions=v,super(),this._initOptions(e),this._createPoints(T,n);const C=e.altitude,k=i.altitudeToVector3(C,C).x,P=u.clone();P.z=k,this.getObject3d().position.copy(P),this._baseObjects=_,this._datas=t,this.faceIndex=null,this._geometriesAttributes=w,this._geometryCache=T.clone(),this.isHide=!1,this._initBaseObjectsEvent(_),this._grids=d,this._bindMapEvents(),this.type="Points",this.maxSize=O}_bindMapEvents(){const t=this.getMap(),e="zoomstart zooming zoomend movestart moving moveend pitch rotate";this.on("add",(()=>{this._updateGrids(),t.on(e,this._updateGrids,this)})),this.on("remove",(()=>{t.off(e,this._updateGrids,this)}))}_updateGrids(){const t=this.getMap();this._grids.forEach((e=>{e.indexs.length&&e.updateBBoxPixel(t)}))}getSelectMesh(){const t=this.faceIndex;if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],{coordinate:n,height:i,color:r,size:o}=e;this._baseObjects[t]=new be(n,{height:i,index:t,color:r,size:o},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){const e=this.getLayer(),n=this.getMap().getSize(),i=this.getLayer().getCamera(),r=this.getOptions().altitude,o=this.getMap(),s=e.altitudeToVector3(r,r).x;let a=this.getObject3d().material.size;const l=void 0===a,h=o.coordToContainerPoint(t),c=[];if(this._grids.forEach((t=>{t.indexs.length&&t.isRecCross(h,l?this.maxSize:a)&&c.push(t)})),c.length<1)return!1;for(let t=0,e=c.length;t<e;t++)for(let e=c[t].positions.length-1;e>=0;e--){l&&(a=this._datas[c[t].indexs[e]].size||1);const r=c[t].positions[e];Oe.x=r.x,Oe.y=r.y,Oe.z=r.z+s;const o=ye(Oe,n,i);if(Math.sqrt(Math.pow(h.x-o.x,2)+Math.pow(h.y-o.y,2))<=a/2)return this.faceIndex=c[t].indexs[e],!0}return!1}}const Se={coordinate:"",radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"};class Te extends(de(m)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const r=t.length,a=E(t),l=i.coordinateToVector3(a),c=[],u=[],d=[];let f=0;const p={},g={};let y;super(),e=o.Util.extend({},{altitude:0,layer:i,points:t},Se,e),this._initOptions(e);const x=new s.Vector3;if(e.asynchronous){y=zt();const e=o.Util.GUID();this.getOptions().id=e;const n=[];for(let e=0;e<r;e++){const r=o.Util.extend({index:e},Se,t[e]),{radius:s,radialSegments:a,altitude:h,height:c,coordinate:u}=r,d=z(s,i,p);t[e]._radius=d;const f=I(c,i,g),y=I(h,i,g),v=i.coordinateToVector3(u,0,x).sub(l);n.push({radialSegments:a,radius:d,height:f,center:[v.x,v.y],altitude:y})}jt.push({id:e,data:n,layer:i,baseObject:this})}else{for(let e=0;e<r;e++){const r=o.Util.extend({index:e},Se,t[e]),{radius:s,radialSegments:a,altitude:y,topColor:v,bottomColor:m,height:b,coordinate:_}=r,w=z(s,i,p),M=I(b,i,g),O=I(y,i,g),A=i.coordinateToVector3(_,0,x).sub(l),j=Vt({radius:w,height:M,radialSegments:a,center:[A.x,A.y]});v&&(Rt(j,m,v,"z",M/2),n.vertexColors=h());const S=j.attributes.position.array;for(let t=0,e=S.length;t<e;t+=3)S[t+2]+=O;c.push(j);const T=new Ht(_,r,n,i);u.push(T),j.index.count;const C=j.attributes.position.count;j.attributes.normal.count,j.attributes.uv.count,d[e]={position:{count:C,start:f,end:f+3*C},hide:!1},f+=3*C}y=Gt(c)}this._createMesh(y,n);const v=e.altitude,m=i.altitudeToVector3(v,v).x,b=l.clone();b.z=m,this.getObject3d().position.copy(b),this._baseObjects=u,this._datas=t,this._geometriesAttributes=d,this.faceIndex=null,this._geometryCache=Lt(y),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(u),e.asynchronous||(this._setPickObject3d(),this._init()),this.type="Bars"}identify(){return this.picked}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,e,{index:t,asynchronous:!1});this._baseObjects[t]=new Ht(e.coordinate,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=Pt(t);this._geometryCache=Lt(n);const{topColor:i,bottomColor:r}=this.getOptions(),o=this.getObject3d(),s=o.material;if(i&&(Rt(n,r,i,"z",e),s.vertexColors=h()),o.geometry=n,o.material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const Ce={width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"};class ke extends(de(m)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const r=[],s=[],a=t.length;for(let e=0;e<a;e++){const n=tt(t[e]);r.push(n.center),s.push(n.lineStrings)}const l=E(r);e=o.Util.extend({},Ce,e,{layer:i,lineStrings:t,coordinate:l});const{altitude:c,topColor:u,bottomColor:d,asynchronous:f}=e;let p;const g=[],y=[];if(super(),f)p=zt(),bt.push({id:o.Util.GUID(),layer:i,key:e.key,center:l,data:s,lineStrings:t,baseObject:this});else{const e=[];let r=0;const c={},f={};for(let n=0;n<a;n++){const a=t[n],h=o.Util.extend({},Ce,w(a)?a.properties:a.getProperties(),{index:n}),{height:u,width:d,bottomHeight:p}=h,g=z(d,i,c),x=I(u,i,f),v=s[n],m=[];let b=0;for(let t=0,e=v.length;t<e;t++){const e=X(v[t],g,x,i,l);b=U(e,p,i,c),m.push(e)}const _=Ct(m);e.push(_);const{position:M,normal:O,indices:A}=_;A.length;const j=M.length/3;O.length,y[n]={position:{middleZ:b+x/2,count:j,start:r,end:r+3*j},hide:!1},r+=3*j}p=Tt(e),u&&(H(p,d,u,y),n.vertexColors=h())}this._initOptions(e),this._createMesh(p,n);const x=i.altitudeToVector3(c,c).x,v=i.coordinateToVector3(l,x);this.getObject3d().position.copy(v),this._baseObjects=g,this._datas=t,this._geometriesAttributes=y,this.faceIndex=null,this._geometryCache=Lt(p),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(g),f||(this._setPickObject3d(),this._init()),this.type="ExtrudeLines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,O(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new Kt(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=Pt(t);this._geometryCache=Lt(n);const{topColor:i,bottomColor:r,bottomHeight:o,height:s}=this.getOptions(),a=this.getObject3d().material;if(i&&(H(n,r,i,e),a.vertexColors=h()),this.getObject3d().geometry=n,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const Pe={altitude:0,colors:null};class Le extends(de(m)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const r=[],a=[],h=t.length;for(let e=0;e<h;e++){const n=tt(t[e]);r.push(n.center),a.push(n.lineStrings)}const c=E(r);e=o.Util.extend({},Pe,e,{layer:i,lineStrings:t,coordinate:c}),super(),this._initOptions(e);const{asynchronous:u}=e;let d;const f=[],p={};let g=[],y=0,x=[];if(u)d=ot(),wt.push({id:o.Util.GUID(),layer:i,key:e.key,center:c,data:a,lineStrings:t,baseObject:this});else{for(let t=0;t<h;t++){const e=a[t];let n=0;for(let t=0,r=e.length;t<r;t++){const r=O(e[t])?e[t].properties:e[t].getProperties()||{},{positions:o}=J(e[t],i,c,!1);U(o,r.bottomHeight,i,p),n+=o.length/3*2-2,x.push(et(o))}g[t]={position:{count:n,start:y,end:y+3*n},hide:!1},y+=3*n}const t=nt(x);d=new s.BufferGeometry,l(d,"position",new s.BufferAttribute(t,3))}this._createLineSegments(d,n);const{altitude:v}=e,m=i.altitudeToVector3(v,v).x,b=i.coordinateToVector3(c,m);this.getObject3d().position.copy(b),this._baseObjects=f,this._datas=t,this._geometriesAttributes=g,this.faceIndex=null,this.index=null,this._geometryCache=d.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(f),u||(this._setPickObject3d(),this._init()),this.type="Lines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=o.Util.extend({},this.getOptions(),{index:t},O(e)?e.properties:e.getProperties());this._baseObjects[t]=new Nt(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_setPickObject3d(){if(!this._colorMap)return;const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:n}=this,i=n.length,r=F(n);let o=0;for(let t=0;t<i;t++){const i=e.getColor(),s=i.getHex();this._colorMap[s]=t;const{count:a}=n[t].position;this._datas[t].colorIndex=s;for(let t=0;t<a;t++)r[o]=i.r,r[o+1]=i.g,r[o+2]=i.b,o+=3}l(t,"color",new s.BufferAttribute(r,3,!0));const a=this.getObject3d().material.clone();a.color.set("#fff"),a.vertexColors=h();const c=e.getColor().getHex(),u=new s.LineSegments(t,a);u.position.copy(this.getObject3d().position),u._colorIndex=c,this.setPickObject3d(u)}identify(t){return this.picked}_workerLoad(t){const{position:e,geometriesAttributes:n}=t;this._geometriesAttributes=n;const i=new s.BufferGeometry;if(l(i,"position",new s.BufferAttribute(new Float32Array(e),3)),this._computeLineDistances(i),this._geometryCache=i.clone(),this.getObject3d().geometry=i,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const Be=[],ze=[];function Ie(){return{waitingQueue:Be,currentQueue:ze}}function Ee(t,e){for(let n=0,i=t.length;n<i;n++){const i=t[n];if(i){const{key:r,callback:o}=i;if(e===r)return t.splice(n,1),o}}return null}const Ue=document.createElement("canvas");let Fe;function Ve(t,e=!1){if(Fe)return Fe;const n=Ue.getContext("2d");return n.clearRect(0,0,256,256),n.save(),Fe=Ue.toDataURL(),Fe}function Re(t=1,e=1){let n;return"undefined"==typeof document||(n=document.createElement("canvas"),t&&(n.width=t),e&&(n.height=e)),n}Ue.width=Ue.height=256;class Ge extends o.TileLayer{constructor(t,e={}){super(o.Util.GUID(),o.Util.extend({urlTemplate:t},e)),this._opts=null,this._layer=null,this.material=null,this.getMaterial=null,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime()}isAsynchronous(){return this._opts.worker}getBaseObjects(){const t=this._loadTiles,e=[];for(let n in t){const t=this._baseObjectKeys[n];if(t&&Array.isArray(t)&&t.length)for(let n=0,i=t.length;n<i;n++)e.push(t[n])}return e}onSelectMesh(t,e){}formatBaseObjects(t,e){return[]}loopMessage(t){}getTileData(t){const{key:e,url:n,callback:i,img:r}=t;o.Ajax.getJSON(n,{},(function(t,n){t?(console.error(t),i(e,null,r)):i(e,n,r)}))}_getCurentTileKeys(){const t=this.getTiles().tileGrids||[],e=[],n={};for(let i=0,r=t.length;i<r;i++){const r=t[i].tiles||[];for(let t=0,i=r.length;t<i;t++){const{id:i}=r[t];e.push(i),n[i]=!0}}return{keys:e,keysMap:n}}_isLoad(){const{keys:t}=this._getCurentTileKeys(),e=Object.keys(this._renderer.tilesInView);return t.length===e.length}_layerOnLoad(){const t=(new Date).getTime();if(t-this._layerLaodTime<20)return;this._layerLaodTime=t;const e=this._renderer.tilesInView,n=this._loadTiles,i=this._layer,r=this._baseObjectKeys,o=Object.keys(e).length,s=Object.keys(n).length,a=[];if(o&&s)for(let t in n)e[t]||r[t]&&(r[t]||[]).forEach((t=>{a.push(t)}));if(a.length&&i.removeMesh(a,!1),o&&s)for(let t in e)if(!n[t])if(r[t]){const e=r[t];i.addMesh(e)}else{const{x:e,y:n,z:i}=this._getXYZOfIndex(t);this.getTileUrl(e,n,i)}this._loadTiles=Object.assign({},e),this._diffCache()}_init(){}_workerLoad(t){const e=t.target._img;e.currentCount++,e.currentCount===e.needCount&&(e.src=Ve(e._key,this._opts.debug))}_generateBaseObjects(t,e,n){if(e&&n){const{keysMap:i}=this._getCurentTileKeys();if(!i[t])return void(n.src=Ve(0,this._opts.debug));const r=this.formatBaseObjects(t,e);if(r.length){n.needCount=r.length,n.currentCount=0;for(let e=0,i=r.length;e<i;e++){const i=r[e];i._img=n,i._vt=this,this.isVisible()||i.hide(),this._cachetile(t,i),i.isAsynchronous()||n.currentCount++}this._layer.addMesh(r,!1),n.needCount===n.currentCount&&(n.src=Ve(0,this._opts.debug)),this.isAsynchronous()?r.filter((t=>t.isAsynchronous())).forEach((t=>{t.on("workerload",this._workerLoad,this)})):n.src=Ve(0,this._opts.debug)}else n.src=Ve(0,this._opts.debug);this._loadTiles[t]=!0}else n&&(n.src=Ve(0,this._opts.debug))}_diffCache(){if(Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max){const t=this._renderer.tileCache.data,e=this._renderer.tilesInView,n=[];for(let i in this._baseObjectKeys)t[i]||e[i]||((this._baseObjectKeys[i]||[]).forEach((t=>{t.isAdd&&n.push(t)})),this._diposeBaseObject(i),delete this._baseObjectKeys[i]);n.length&&this._layer.removeMesh(n,!1)}}_diposeBaseObject(t){const e=this._baseObjectKeys[t];e&&e.length&&e.forEach((t=>{t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();const e=t._baseObjects;e&&e.length&&e.forEach((t=>{t.getObject3d().geometry.dispose(),t=null})),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t._colorMap=null,t.pickObject3d&&t.pickObject3d.geometry.dispose(),t=null}))}_cachetile(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)}_getXYZOfIndex(t){const e=t.indexOf("_")>-1?"_":"-";let[n,i,r]=t.split(e).slice(1,4);return{x:parseInt(i),y:parseInt(n),z:parseInt(r)}}_getTileExtent(t,e,n){const i=this.getMap()._getResolution(n);return this._getTileConfig().getTilePrjExtent(t,e,i)}_getTileLngLatExtent(t,e,n){const i=this._getTileExtent(t,e,n);let r=i.getMax(),s=i.getMin();const a=this.getMap().getProjection();return s=a.unproject(s),r=a.unproject(r),new o.Extent(s,r)}}const Ze={worker:!1};class De extends Ge{constructor(t,e={},n,i){super(o.Util.GUID(),o.Util.extend({urlTemplate:t},Ze,e)),this._opts=e,this._layer=i,this.getMaterial=n,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime(),this._init()}formatBaseObjects(t,e){const n=this._opts,i=[],r=this.isAsynchronous();for(let a in e){const l=e[a]||{};let h;if(Array.isArray(l)?h=l:"FeatureCollection"===l.type&&(h=l.features),h&&h.length){const e=[],c=[],u=[];for(let t=0,n=h.length;t<n;t++){const n=h[t];if(M(n))e.push(n);else if(O(n)){const t=C(n);for(let e=0,n=t.length;e<n;e++)c.push(t[e])}else if(A(n)){const t=C(n);for(let e=0,n=t.length;e<n;e++)u.push(o.Util.extend({},t[e].properties,t[e],{coordinate:S(t[e])}))}}if(e.length){const s=this._getMaterial(a,e,t,l);if(s){const l=this._layer.toExtrudePolygons(e,o.Util.extend({},{topColor:"#fff",layerName:a,asynchronous:r,key:t},n),s);i.push(l)}}if(c.length){const e=this._getMaterial(a,c,t,l);if(e&&(e instanceof s.LineBasicMaterial||e instanceof s.LineDashedMaterial)){const t=this._layer.toLines(c,o.Util.extend({},{layerName:a,asynchronous:r},n),e);i.push(t)}}if(u.length){const e=this._getMaterial(a,u,t,l);if(e&&e instanceof s.PointsMaterial){const t=this._layer.toPoints(u,o.Util.extend({},{layerName:a,asynchronous:r},n),e);i.push(t)}}}}return i}loopMessage(t){const{currentQueue:e}=Ie();e.length>0&&this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",(()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval((()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")}),1e3)})),this.on("remove",(()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)})),this.on("show",(()=>{this.getBaseObjects().forEach((t=>{t.show()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.show()}))}})),this.on("hide",(()=>{this.getBaseObjects().forEach((t=>{t.hide()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.hide()}))}})),this.on("renderercreate",(t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},t.renderer.deleteTile=function(t){if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;!function(t){const e=Ee(Be,t);e&&e(t)}((t.info||{}).id)},t.renderer.loadTileImage=(t,e,n)=>{t._key=n,function(t,e,n,i,r){const o={key:t,url:e,callback:n,img:i,vt:r};ze.length<10?(ze.push(o),r.loopMessage(o)):Be.push(o)}(n,e,((t,e,n)=>{this._generateBaseObjects(t,e,n),function(t,e){if(Ee(ze,t),Be.length){ze.push(Be[0]),Be.splice(0,1);const t=ze[ze.length-1];e.loopMessage(t)}}(t,this)}),t,this)}}))}_getMaterial(t,e,n,i){return this.getMaterial&&o.Util.isFunction(this.getMaterial)?this.getMaterial(t,e,n,i):null}}function He(t,e,n,i){const{position:r,uv:o,normal:a,indexs:h}=function(t,e,n,i){const r=t/n,o=e/i,s=-t/2,a=e/2,l=-e/2,h=(n+1)*(i+1),c=new Float32Array(3*h),u=new Float32Array(2*h),d=new Float32Array(3*h),f=new Uint32Array(10*h);let p=0,g=0,y=0;for(let h=0;h<=i;h++)for(let x=0;x<=n;x++){const v=s+r*x,m=a-o*h;c[p]=v,c[p+1]=m,c[p+2]=0,d[p]=0,d[p+1]=0,d[p+2]=1;const b=(v-s)/t,_=(m-l)/e;if(u[g]=b,u[g+1]=_,p+=3,g+=2,x<n&&h<i){const t=h*(n+1)+x,e=t+1,i=(n+1)*(h+1)+x,r=i+1;f[y]=t,f[y+1]=i,f[y+2]=e,f[y+3]=i,f[y+4]=r,f[y+5]=e,y+=6}}const x=new Uint32Array(y);for(let t=0,e=x.length;t<e;t++)x[t]=f[t];return{position:c,uv:u,normal:d,indexs:x}}(t,e,n,i),c=new s.BufferGeometry;return l(c,"position",new s.BufferAttribute(r,3)),l(c,"normal",new s.BufferAttribute(a,3)),l(c,"uv",new s.BufferAttribute(o,2)),c.setIndex(new s.BufferAttribute(h,1)),c}const Qe=new s.TextureLoader,We=document.createElement("canvas");function Ne(t){if(!t)return null;let e;return"string"==typeof t?(e=new Image,e.src=t):t instanceof HTMLCanvasElement?(e=new Image,e.src=t.toDataURL()):t instanceof Image&&(e=new Image,e.src=t.src,e.crossOrigin=t.crossOrigin),e&&!e.crossOrigin&&(e.crossOrigin="Anonymous"),e}const qe=new Map;function Ke(t,e,n,i){if(!e||!n)return;const{imageWidth:r,imageHeight:o}=i;let a;if(a=t instanceof Uint32Array||t instanceof Uint8ClampedArray?t:function(t,e=256,n=256){We.width=e,We.height=n;const i=We.getContext("2d");return i.drawImage(t,0,0,e,n),i.getImageData(0,0,e,n).data}(t,r,o),!a)return void console.error("image is error type data",t);let l=0,h=0,c=0;const u=new s.Vector3,d=qe;for(let t=0,i=a.length;t<i;t+=4){const i=.1*(256*a[t]*256+256*a[t+1]+a[t+2])-1e4;let s=0;if(0!==h&&h+1!==o&&0!==c&&c+1!==r){const t=d.get(i);void 0!==t?s=t:(s=n.altitudeToVector3(i,i,null,u).x,d.set(i,s))}e.attributes.position.array[3*l+2]=s,l++,c++,c===r&&(h++,c=0)}e.attributes.position.needsUpdate=!0}const Je={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null};class Ye extends m{constructor(t,e,n,i){e=o.Util.extend({},Je,e,{layer:i,extent:t});const{texture:r,image:s,altitude:a,imageHeight:l,imageWidth:h}=e;t instanceof o.Extent||(t=new o.Extent(t));const{xmin:c,ymin:u,xmax:d,ymax:f}=t;let p=1/0,g=1/0,y=-1/0,x=-1/0;[[c,u],[c,f],[d,f],[d,u]].forEach((t=>{const e=i.coordinateToVector3(t),{x:n,y:r}=e;p=Math.min(n,p),g=Math.min(r,g),y=Math.max(n,y),x=Math.max(r,x)}));const v=(y-p)/h,m=(x-g)/l;p-=v,y+=v,g-=m,x+=m;const b=Math.abs(y-p),_=Math.abs(x-g),w=Ne(s),M=Ne(r),O=He(b,_,h-1,l-1);super(),this._initOptions(e),this._createMesh(O,n);const A=i.altitudeToVector3(a,a).x,j=i.coordinateToVector3(t.getCenter(),A);this.getObject3d().position.copy(j),n.transparent=!0,w&&(w.onload=()=>{Ke(w,O,i,{imageWidth:h,imageHeight:l})},w.onerror=function(){console.error(`not load ${w.src}`)}),M?(n.opacity=0,Qe.load(M.src,(t=>{n.map=t,n.opacity=1,n.needsUpdate=!0}))):n.opacity=1,this.type="Terrain"}updateData(t){return Ke(t,this.getObject3d().geometry,this.getLayer(),this.getOptions()),this}}const $e={scale:1,tileDivisor:4};class Xe extends Ge{constructor(t,e={},n,i){super(o.Util.GUID(),o.Util.extend({urlTemplate:t},$e,e)),this._opts=e,this._layer=i,this.material=n,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._imgQueue={},this._layerLaodTime=(new Date).getTime(),this._init()}isAsynchronous(){return!1}formatBaseObjects(t,e){const n=this.options,i=[],{scale:r,tileDivisor:o}=n,{x:s,y:a,z:l}=this._getXYZOfIndex(t),h=this.getMap().getZoom(),c=this.getTileUrl(s,a,l),[u,d]=this.options.tileSize,f=this._getTileLngLatExtent(s,a,l),p=this.material.clone();if(l+1>=Math.round(h)){const t=new Ye(f,{image:e,imageWidth:u/o,imageHeight:d/o,texture:c},p,this._layer);t.getObject3d().scale.set(r,r,1),i.push(t)}return i}loopMessage(t){this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",(()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval((()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")}),1e3)})),this.on("remove",(()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)})),this.on("show",(()=>{this.getBaseObjects().forEach((t=>{t.show()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.show()}))}})),this.on("hide",(()=>{this.getBaseObjects().forEach((t=>{t.hide()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.hide()}))}})),this.on("renderercreate",(t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},t.renderer.deleteTile=t=>{if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;const e=t.info||{},n=this._imgQueue[e.id];n&&(n.src="",n.onload=null,n.onerror=null,delete this._imgQueue[e.id])},t.renderer.loadTileImage=(t,e,n)=>{t._key=n;const i=new Image;this._imgQueue[n]=i;const r={key:n,url:e,rgbImage:i,callback:(t,e,n)=>{this._generateBaseObjects(t,e,n)},img:t,vt:this};this.loopMessage(r)}}))}}
/*!
     * Code from baidu mapv
     * License: BSD-3
     * https://github.com/huiyan-fe/mapv
     *
     */function tn(t){t=t||{},this.gradient=t.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}function en(t,e,n){var i=nn(n),r=function(t){return t.min||0}(n),o=i-r,s=n.range||null,a=0,l=1024;s&&2===s.length&&(a=(s[0]-r)/o*1024),s&&2===s.length&&(l=(s[1]-r)/o*1024);for(var h,c=n.maxOpacity||.8,u=n.minOpacity||0,d=3,f=t.length;d<f;d+=4)h=4*t[d],t[d]/256>c&&(t[d]=256*c),t[d]/256<u&&(t[d]=256*u),h&&h>=a&&h<=l?(t[d-3]=e[h],t[d-2]=e[h+1],t[d-1]=e[h+2]):t[d]=0}function nn(t){return t.max||100}function rn(t,e,n){var i=nn(n),r=
/*!
     * Code from baidu mapv
     * License: BSD-3
     * https://github.com/huiyan-fe/mapv
     *
     */
function(t){var e=t/2,n=t+e,i=1e4,r=Re(2*n,2*n),o=r.getContext("2d");return o.shadowBlur=e,o.shadowColor="black",o.shadowOffsetX=o.shadowOffsetY=i,o.beginPath(),o.arc(n-i,n-i,t,0,2*Math.PI,!0),o.closePath(),o.fill(),r}(n._size||n.size||13),o=r.width/2,s=r.height/2,a=e,l={};for(var h in a.forEach((function(t){var e=void 0===t.count?1:t.count,n=Math.min(1,e/i).toFixed(2);l[n]=l[n]||[],l[n].push(t)})),l)if(!isNaN(h)){var c=l[h];t.beginPath(),n.withoutAlpha||(t.globalAlpha=h),c.forEach((function(e){var n=e.coordinate,a=void 0===e.count?1:e.count;t.globalAlpha=a/i,t.drawImage(r,n[0]-o,n[1]-s)}))}}tn.prototype.setMax=function(t){this.max=t||100},tn.prototype.setMin=function(t){this.min=t||0},tn.prototype.setMaxSize=function(t){this.maxSize=t||35},tn.prototype.setMinSize=function(t){this.minSize=t||0},tn.prototype.initPalette=function(){var t=this.gradient,e=Re(256,1),n=this.paletteCtx=e.getContext("2d"),i=n.createLinearGradient(0,0,256,1);for(var r in t)i.addColorStop(parseFloat(r),t[r]);n.fillStyle=i,n.fillRect(0,0,256,1)},tn.prototype.getColor=function(t){var e=this.getImageData(t);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]/256+")"},tn.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var n=this.max,i=this.min;t>n&&(t=n),t<i&&(t=i);var r=4*Math.floor((t-i)/(n-i)*255);return[e[r],e[r+1],e[r+2],e[r+3]]},tn.prototype.getSize=function(t){var e=this.max,n=this.min,i=this.maxSize,r=this.minSize;return t>e&&(t=e),t<n&&(t=n),e>n?r+(t-n)/(e-n)*(i-r):i},tn.prototype.getLegend=function(t){var e=this.gradient,n=t.width||20,i=t.height||180,r=Re(n,i),o=r.getContext("2d"),s=o.createLinearGradient(0,i,0,0);for(var a in e)s.addColorStop(parseFloat(a),e[a]);return o.fillStyle=s,o.fillRect(0,0,n,i),r};var on={draw:function(t,e,n){if(!(t.canvas.width<=0||t.canvas.height<=0)){var i=n.strength||.3;t.strokeStyle="rgba(0,0,0,"+i+")";var r=Re(t.canvas.width,t.canvas.height),o=r.getContext("2d");o.scale(devicePixelRatio,devicePixelRatio),n=n||{},t.save();var s=new tn({gradient:n.gradient});if(rn(o,e,n),!n.absolute){var a=o.getImageData(0,0,t.canvas.width,t.canvas.height);en(a.data,s.getImageData(),n),t.putImageData(a,0,0),t.restore()}s=null,r=null}},drawGray:rn,colorize:en};const sn={altitude:0,interactive:!1,min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5},an=2048;class ln extends m{constructor(t,e,n,i){Array.isArray(t)||(t=[t]);let r=1/0,a=1/0,c=-1/0,u=-1/0;const d=[];for(let e=0,n=t.length;e<n;e++){const{coordinate:n,lnglat:o,xy:s}=t[e],l=n||o||s;if(!l){console.warn("not find coordinate");continue}const h=i.coordinateToVector3(l);d.push(h);const{x:f,y:p}=h;r=Math.min(r,f),a=Math.min(a,p),c=Math.max(c,f),u=Math.max(u,p)}e=o.Util.extend({},sn,e,{layer:i,points:t});let{gridScale:f,altitude:p}=e;const g=Math.abs(c-r),y=Math.abs(u-a),x=Math.max(g*f,y*f);if(x>an){console.warn(`gridScale: ${f} it's too big. I hope it's a smaller value,canvas max size is 2048* 2048`);f=an/(x/f)}const v=Math.ceil(g*f),m=Math.ceil(y*f),b=v/g,_=m/y,w=[];for(let e=0,n=d.length;e<n;e++){const n=d[e];n.x-=r,n.y-=a,n.x*=b,n.y*=_,n.y=m-n.y,w.push({coordinate:[n.x,n.y],count:t[e].count})}let M=Re(v,m),O=M.getContext("2d");on.drawGray(O,w,e);const A=O.getImageData(0,0,O.canvas.width,O.canvas.height);let j=-1/0;const S=new Float32Array(A.data.length/4),T=new Float32Array(A.data.length/4);for(let t=3,e=A.data.length,n=0;t<e;t+=4){const e=A.data[t];j=Math.max(j,e),T[n]=e,e<=0&&(S[n]=1),n++}const C=new tn({gradient:e.gradient});on.colorize(A.data,C.getImageData(),e),M=null,O=null;const k=He(g,y,v-1,m-1),P=k.getIndex().array,L=k.attributes.position.array,B=new Float32Array(L.length),z=new Uint32Array(6*L.length),I=new s.Color;let E=0;for(let t=0,e=L.length,n=0,i=P.length,r=0,o=A.data.length,s=0;t<Math.max(e,i,o);t+=3){if(t<e){const e=T[s];e>0&&(L[t+2]=e/j)}if(n<i){const t=P[n],e=P[n+1],i=P[n+2];S[t]&&S[e]&&S[i]||(z[E]=t,z[E+1]=e,z[E+2]=i,E+=3)}if(r<o){const t=`rgb(${A.data[r]},${A.data[r+1]},${A.data[r+2]})`;I.setStyle(t),B[n]=I.r,B[n+1]=I.g,B[n+2]=I.b}n+=3,r+=4,s++}const U=new Uint32Array(E);for(let t=0;t<E;t++)U[t]=z[t];k.setIndex(new s.BufferAttribute(U,1)),l(k,"color",new s.BufferAttribute(B,3,!0)),n.vertexColors=h(),super(),this._initOptions(e),this._createMesh(k,n);const F=i.altitudeToVector3(p,p).x;this.getObject3d().position.copy(new s.Vector3((r+c)/2,(a+u)/2,F)),this.type="HeatMap"}}const hn=new s.Color;let cn=1;class un{constructor(t){this.object3ds=[],this.layer=t,this.camera=t.getCamera(),this.renderer=t.getThreeRenderer(),this.pickingTexture=new s.WebGLRenderTarget(1,1),this.pickingScene=new s.Scene}getColor(){return hn.setHex(cn),cn++,hn}add(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=t,this.pickingScene.add(t))}return this}remove(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=null,this.pickingScene.remove(t))}return this}isEmpty(){if(0===this.pickingScene.children.length)return!0;for(let t=0,e=this.pickingScene.children.length;t<e;t++){const e=this.pickingScene.children[t];if(e){const t=e.__parent;if(t&&!0===t.getOptions().interactive)return!1}}return!0}pick(t){if(!t)return;if(this.isEmpty())return;const{camera:e,renderer:n,pickingTexture:i,pickingScene:r,object3ds:o,layer:s}=this,a=this.pickingScene.children.length;for(let t=0;t<a;t++){const e=this.pickingScene.children[t];e&&e.__parent&&(e.__parent.picked=!1)}const{width:l,height:h}=s._getRenderer().canvas,c=i.width,u=i.height;l===c&&h===u||i.setSize(l,h),n.setRenderTarget(i),n.clear(),e&&e.layers&&this.camera.layers.set(0),n.render(r,e);const d=new Uint8Array(4),{x:f,y:p}=t,g=window.devicePixelRatio,y=f*g,x=i.height-p*g;n.readRenderTargetPixels(i,Math.round(y),Math.round(x),1,1,d);const v=d[0]<<16|d[1]<<8|d[2],m=o[v];if(m)m.__parent&&(o[v].__parent.picked=!0);else for(let t=0;t<a;t++){const e=this.pickingScene.children[t];if(e&&e.__parent){const t=e.__parent;if(t._colorMap&&null!=t._colorMap[v]){t.picked=!0,t.index=t._colorMap[v];break}}}n.setRenderTarget(null)}}const dn={bottomHeight:0,altitude:0};class fn extends m{constructor(t,e,n,i){e=o.Util.extend({},dn,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{asynchronous:r}=e,{lineStrings:s,center:a}=tt(t),l=new g;let h;if(r){const e=o.Util.GUID();this.getOptions().id=e,this.getOptions().center=a,Mt.push({id:e,data:s,lineString:t,center:a,layer:i,baseObject:this})}else{const t=[],n={};for(let r=0,o=s.length;r<o;r++){const o=J(s[r],i,a,!1).positions;U(o,e.bottomHeight,i,n),t.push(et(o))}h=nt(t),l.setPositions(h)}this._setMaterialRes(i,n),this._createLine2(l,n);const{altitude:c}=e,u=i.altitudeToVector3(c,c).x,d=i.coordinateToVector3(a,u);this.getObject3d().position.copy(d),r||(this._setPickObject3d(h,n.linewidth),this._init()),this.type="FatLine"}_init(){const t=this.getLayer().getPick();this.on("add",(()=>{t.add(this.pickObject3d)})),this.on("remove",(()=>{t.remove(this.pickObject3d)}))}_setMaterialRes(t,e){const n=t.getMap().getSize(),i=n.width,r=n.height;e.resolution.set(i,r)}_setPickObject3d(t,e){const n=new g;n.setPositions(t);const i=this.getLayer().getPick().getColor(),r=[];for(let e=0,n=t.length/3;e<n;e++)r.push(i.r,i.g,i.b);n.setColors(r);const o=new f({color:"#fff",linewidth:e,vertexColors:h()});this._setMaterialRes(this.getLayer(),o);const s=i.getHex(),a=new y(n,o);a.position.copy(this.getObject3d().position),a._colorIndex=s,this.setPickObject3d(a)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof s.Material){t.needsUpdate=!0;const e=this.getMap().getSize(),n=e.width,i=e.height;t.resolution.set(n,i),this.getObject3d().material=t}return this}_workerLoad(t){const e=new Float32Array(t.position),n=this.getObject3d();if(n.geometry.setPositions(e),n.computeLineDistances(),this._setPickObject3d(e,n.material.linewidth),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const pn={altitude:0,colors:null};class gn extends(de(m)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const r=[],s=[],a=t.length;for(let e=0;e<a;e++){const n=tt(t[e]);r.push(n.center),s.push(n.lineStrings)}const l=E(r);e=o.Util.extend({},pn,e,{layer:i,lineStrings:t,coordinate:l}),super(),this._initOptions(e);const{asynchronous:h}=e,c=new g,u=[],d={};let f,p,y=[],x=0,v=[];if(h)Ot.push({id:o.Util.GUID(),data:s,key:e.key,center:l,layer:i,baseObject:this,lineStrings:t});else{for(let t=0;t<a;t++){const e=s[t];let n=0;for(let t=0,r=e.length;t<r;t++){const r=O(e[t])?e[t].properties:e[t].getProperties()||{},{positions:o}=J(e[t],i,l,!1);U(o,r.bottomHeight,i,d),n+=o.length/3*2-2,v.push(et(o))}y[t]={position:{count:n,start:x,end:x+3*n},instanceStart:{count:n,start:x,end:x+3*n},instanceEnd:{count:n,start:x,end:x+3*n},hide:!1},x+=3*n}f=nt(v),c.setPositions(f)}this._setMaterialRes(i,n),this._createLine2(c,n);const{altitude:m}=e,b=i.altitudeToVector3(m,m).x,_=i.coordinateToVector3(l,b);this.getObject3d().position.copy(_),this._baseObjects=u,this._datas=t,this._geometriesAttributes=y,this.faceIndex=null,this.index=null,this._geometryCache=new g,h||(p=new Float32Array(f),this._geometryCache.setPositions(p)),this._colorMap={},this.isHide=!1,this._initBaseObjectsEvent(u),h||(this._setPickObject3d(p,n.linewidth),this._init()),this.type="FatLines"}_setMaterialRes(t,e){const n=t.getMap().getSize(),i=n.width,r=n.height;e.resolution.set(i,r)}_setPickObject3d(t,e){if(!this._colorMap)return;const n=this._geometryCache||new g;n.setPositions(t);const i=this.getLayer().getPick(),{_geometriesAttributes:r}=this,o=F(r);let s=0;for(let t=0,e=r.length;t<e;t++){const e=i.getColor(),n=e.getHex();this._colorMap[n]=t;const{count:a}=r[t].position;this._datas[t].colorIndex=n;for(let t=0;t<a;t++)o[s]=e.r,o[s+1]=e.g,o[s+2]=e.b,s+=3}n.setColors(o);const a=new f({color:"#fff",linewidth:e,vertexColors:h()});this._setMaterialRes(this.getLayer(),a);const l=i.getColor().getHex(),c=new y(n,a);c.position.copy(this.getObject3d().position),c._colorIndex=l,this.setPickObject3d(c)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof s.Material){t.needsUpdate=!0;const e=this.getMap().getSize(),n=e.width,i=e.height;t.resolution.set(n,i),this.getObject3d().material=t}return this}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=o.Util.extend({},this.getOptions(),{index:t},O(e)?e.properties:e.getProperties());this._baseObjects[t]=new fn(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_updateAttribute(t,e){const{indexs:n}=this._getHideGeometryIndex(e),i=this._geometryCache.attributes[e].array,r=i.length;for(let e=0;e<r;e++)t.array[e]=i[e];for(let i=0;i<n.length;i++){const r=n[i],{start:o,end:s}=this._geometriesAttributes[r][e];for(let e=o;e<s;e++)t.array[e]=-1e5}return this}_showGeometry(t,e){let n;if(t&&(n=t.getOptions().index),null!=n){const t=this._geometriesAttributes[n],{hide:i}=t;if(i===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.instanceStart,"instanceStart"),this._updateAttribute(r.attributes.instanceEnd,"instanceEnd"),r.attributes.instanceStart.data.needsUpdate=!0,r.attributes.instanceEnd.data.needsUpdate=!0,this.isHide=e}return this}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=this.getObject3d(),i=new Float32Array(t.position),r=new Float32Array(i);if(n.geometry.setPositions(new Float32Array(i)),this._geometryCache.setPositions(r),this._setPickObject3d(r,n.material.linewidth),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const yn={radius:10,height:100,altitude:0,topColor:"",bottomColor:"#2d2f61",heightEnable:!0};class xn extends m{constructor(t,e,n,i){e=o.Util.extend({},yn,e,{layer:i,coordinate:t}),super(),this._initOptions(e);const{height:r,radius:s,topColor:a,bottomColor:l,altitude:c}=e,u=i.altitudeToVector3(r,r).x,d=i.distanceToVector3(s,s).x,f=Zt().clone();f.scale(2*d,2*d,u),a&&(Rt(f,l,a,"z",u/2),n.vertexColors=h()),this._createMesh(f,n);const p=i.altitudeToVector3(c,c).x,g=i.coordinateToVector3(t,p);this.getObject3d().position.copy(g),this.type="Box"}}const vn={radius:10,height:100,altitude:0,topColor:null,bottomColor:"#2d2f61"};class mn extends(de(m)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const r=t.length,s=E(t),a=i.coordinateToVector3(s),l=[],c=[],u=[];let d=0;const f={},p={};for(let e=0;e<r;e++){const r=o.Util.extend({index:e},vn,t[e]),{radius:s,altitude:g,topColor:y,bottomColor:x,height:v,coordinate:m}=r,b=z(s,i,f),_=I(v,i,p),w=I(g,i,p),M=Zt().clone();M.scale(2*b,2*b,_),y&&(Rt(M,x,y,"z",_/2),n.vertexColors=h());const O=i.coordinateToVector3(m).sub(a),A=M.attributes.position.array;for(let t=0,e=A.length;t<e;t+=3)A[t+2]+=w,A[t]+=O.x,A[t+1]+=O.y,A[t+2]+=O.z;l.push(M);const j=new xn(m,r,n,i);c.push(j),M.index.count;const S=M.attributes.position.count;M.attributes.normal.count,M.attributes.uv.count,u[e]={position:{count:S,start:d,end:d+3*S},hide:!1},d+=3*S}super(),e=o.Util.extend({},{altitude:0,layer:i,points:t},e),this._initOptions(e);const g=Gt(l);this._createMesh(g,n);const y=e.altitude,x=i.altitudeToVector3(y,y).x,v=a.clone();v.z=x,this.getObject3d().position.copy(v),this._baseObjects=c,this._datas=t,this._geometriesAttributes=u,this.faceIndex=null,this._geometryCache=Lt(g),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(c),this._setPickObject3d(),this._init(),this.type="Boxs"}identify(t){return this.picked}}var bn={exports:{}};function _n(t,e,n){n=n||2;var i,r,o,s,a,l,h,c=e&&e.length,u=c?e[0]*n:t.length,d=wn(t,0,u,n,!0),f=[];if(!d||d.next===d.prev)return f;if(c&&(d=function(t,e,n,i){var r,o,s,a=[];for(r=0,o=e.length;r<o;r++)(s=wn(t,e[r]*i,r<o-1?e[r+1]*i:t.length,i,!1))===s.next&&(s.steiner=!0),a.push(Bn(s));for(a.sort(Cn),r=0;r<a.length;r++)n=Mn(n=kn(a[r],n),n.next);return n}(t,e,d,n)),t.length>80*n){i=o=t[0],r=s=t[1];for(var p=n;p<u;p+=n)(a=t[p])<i&&(i=a),(l=t[p+1])<r&&(r=l),a>o&&(o=a),l>s&&(s=l);h=0!==(h=Math.max(o-i,s-r))?1/h:0}return On(d,f,n,i,r,h),f}function wn(t,e,n,i,r){var o,s;if(r===Wn(t,e,n,i)>0)for(o=e;o<n;o+=i)s=Dn(o,t[o],t[o+1],s);else for(o=n-i;o>=e;o-=i)s=Dn(o,t[o],t[o+1],s);return s&&Un(s,s.next)&&(Hn(s),s=s.next),s}function Mn(t,e){if(!t)return t;e||(e=t);var n,i=t;do{if(n=!1,i.steiner||!Un(i,i.next)&&0!==En(i.prev,i,i.next))i=i.next;else{if(Hn(i),(i=e=i.prev)===i.next)break;n=!0}}while(n||i!==e);return e}function On(t,e,n,i,r,o,s){if(t){!s&&o&&function(t,e,n,i){var r=t;do{null===r.z&&(r.z=Ln(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,n,i,r,o,s,a,l,h=1;do{for(n=t,t=null,o=null,s=0;n;){for(s++,i=n,a=0,e=0;e<h&&(a++,i=i.nextZ);e++);for(l=h;a>0||l>0&&i;)0!==a&&(0===l||!i||n.z<=i.z)?(r=n,n=n.nextZ,a--):(r=i,i=i.nextZ,l--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;n=i}o.nextZ=null,h*=2}while(s>1)}(r)}(t,i,r,o);for(var a,l,h=t;t.prev!==t.next;)if(a=t.prev,l=t.next,o?jn(t,i,r,o):An(t))e.push(a.i/n),e.push(t.i/n),e.push(l.i/n),Hn(t),t=l.next,h=l.next;else if((t=l)===h){s?1===s?On(t=Sn(Mn(t),e,n),e,n,i,r,o,2):2===s&&Tn(t,e,n,i,r,o):On(Mn(t),e,n,i,r,o,1);break}}}function An(t){var e=t.prev,n=t,i=t.next;if(En(e,n,i)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(zn(e.x,e.y,n.x,n.y,i.x,i.y,r.x,r.y)&&En(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function jn(t,e,n,i){var r=t.prev,o=t,s=t.next;if(En(r,o,s)>=0)return!1;for(var a=r.x<o.x?r.x<s.x?r.x:s.x:o.x<s.x?o.x:s.x,l=r.y<o.y?r.y<s.y?r.y:s.y:o.y<s.y?o.y:s.y,h=r.x>o.x?r.x>s.x?r.x:s.x:o.x>s.x?o.x:s.x,c=r.y>o.y?r.y>s.y?r.y:s.y:o.y>s.y?o.y:s.y,u=Ln(a,l,e,n,i),d=Ln(h,c,e,n,i),f=t.prevZ,p=t.nextZ;f&&f.z>=u&&p&&p.z<=d;){if(f!==t.prev&&f!==t.next&&zn(r.x,r.y,o.x,o.y,s.x,s.y,f.x,f.y)&&En(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,p!==t.prev&&p!==t.next&&zn(r.x,r.y,o.x,o.y,s.x,s.y,p.x,p.y)&&En(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(;f&&f.z>=u;){if(f!==t.prev&&f!==t.next&&zn(r.x,r.y,o.x,o.y,s.x,s.y,f.x,f.y)&&En(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;p&&p.z<=d;){if(p!==t.prev&&p!==t.next&&zn(r.x,r.y,o.x,o.y,s.x,s.y,p.x,p.y)&&En(p.prev,p,p.next)>=0)return!1;p=p.nextZ}return!0}function Sn(t,e,n){var i=t;do{var r=i.prev,o=i.next.next;!Un(r,o)&&Fn(r,i,i.next,o)&&Gn(r,o)&&Gn(o,r)&&(e.push(r.i/n),e.push(i.i/n),e.push(o.i/n),Hn(i),Hn(i.next),i=t=o),i=i.next}while(i!==t);return Mn(i)}function Tn(t,e,n,i,r,o){var s=t;do{for(var a=s.next.next;a!==s.prev;){if(s.i!==a.i&&In(s,a)){var l=Zn(s,a);return s=Mn(s,s.next),l=Mn(l,l.next),On(s,e,n,i,r,o),void On(l,e,n,i,r,o)}a=a.next}s=s.next}while(s!==t)}function Cn(t,e){return t.x-e.x}function kn(t,e){var n=function(t,e){var n,i=e,r=t.x,o=t.y,s=-1/0;do{if(o<=i.y&&o>=i.next.y&&i.next.y!==i.y){var a=i.x+(o-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=r&&a>s){if(s=a,a===r){if(o===i.y)return i;if(o===i.next.y)return i.next}n=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!n)return null;if(r===s)return n;var l,h=n,c=n.x,u=n.y,d=1/0;i=n;do{r>=i.x&&i.x>=c&&r!==i.x&&zn(o<u?r:s,o,c,u,o<u?s:r,o,i.x,i.y)&&(l=Math.abs(o-i.y)/(r-i.x),Gn(i,t)&&(l<d||l===d&&(i.x>n.x||i.x===n.x&&Pn(n,i)))&&(n=i,d=l)),i=i.next}while(i!==h);return n}(t,e);if(!n)return e;var i=Zn(n,t),r=Mn(n,n.next);return Mn(i,i.next),e===n?r:e}function Pn(t,e){return En(t.prev,t,e.prev)<0&&En(e.next,t,t.next)<0}function Ln(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Bn(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function zn(t,e,n,i,r,o,s,a){return(r-s)*(e-a)-(t-s)*(o-a)>=0&&(t-s)*(i-a)-(n-s)*(e-a)>=0&&(n-s)*(o-a)-(r-s)*(i-a)>=0}function In(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Fn(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Gn(t,e)&&Gn(e,t)&&function(t,e){var n=t,i=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)&&(En(t.prev,t,e.prev)||En(t,e.prev,e))||Un(t,e)&&En(t.prev,t,t.next)>0&&En(e.prev,e,e.next)>0)}function En(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function Un(t,e){return t.x===e.x&&t.y===e.y}function Fn(t,e,n,i){var r=Rn(En(t,e,n)),o=Rn(En(t,e,i)),s=Rn(En(n,i,t)),a=Rn(En(n,i,e));return r!==o&&s!==a||(!(0!==r||!Vn(t,n,e))||(!(0!==o||!Vn(t,i,e))||(!(0!==s||!Vn(n,t,i))||!(0!==a||!Vn(n,e,i)))))}function Vn(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function Rn(t){return t>0?1:t<0?-1:0}function Gn(t,e){return En(t.prev,t,t.next)<0?En(t,e,t.next)>=0&&En(t,t.prev,e)>=0:En(t,e,t.prev)<0||En(t,t.next,e)<0}function Zn(t,e){var n=new Qn(t.i,t.x,t.y),i=new Qn(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function Dn(t,e,n,i){var r=new Qn(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function Hn(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Qn(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Wn(t,e,n,i){for(var r=0,o=e,s=n-i;o<n;o+=i)r+=(t[s]-t[o])*(t[o+1]+t[s+1]),s=o;return r}bn.exports=_n,bn.exports.default=_n,_n.deviation=function(t,e,n,i){var r=e&&e.length,o=r?e[0]*n:t.length,s=Math.abs(Wn(t,0,o,n));if(r)for(var a=0,l=e.length;a<l;a++){var h=e[a]*n,c=a<l-1?e[a+1]*n:t.length;s-=Math.abs(Wn(t,h,c,n))}var u=0;for(a=0;a<i.length;a+=3){var d=i[a]*n,f=i[a+1]*n,p=i[a+2]*n;u+=Math.abs((t[d]-t[p])*(t[f+1]-t[d+1])-(t[d]-t[f])*(t[p+1]-t[d+1]))}return 0===s&&0===u?0:Math.abs((u-s)/s)},_n.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},i=0,r=0;r<t.length;r++){for(var o=0;o<t[r].length;o++)for(var s=0;s<e;s++)n.vertices.push(t[r][o][s]);r>0&&(i+=t[r-1].length,n.holes.push(i))}return n};var Nn=bn.exports;function qn(t,e,n){var i=e[0],r=e[1],o=n[0]-i,s=n[1]-r;if(0!==o||0!==s){var a=((t[0]-i)*o+(t[1]-r)*s)/(o*o+s*s);a>1?(i=n[0],r=n[1]):a>0&&(i+=o*a,r+=s*a)}return(o=t[0]-i)*o+(s=t[1]-r)*s}function Kn(t,e,n,i,r){for(var o,s=i,a=e+1;a<n;a++){var l=qn(t[a],t[e],t[n]);l>s&&(o=a,s=l)}s>i&&(o-e>1&&Kn(t,e,o,i,r),r.push(t[o]),n-o>1&&Kn(t,o,n,i,r))}function Jn(t,e){var n=t.length-1,i=[t[0]];return Kn(t,0,n,e,i),i.push(t[n]),i}function Yn(t,e,n){if(t.length<=2)return t;var i=void 0!==e?e*e:1;return t=n?t:function(t,e){for(var n,i,r,o,s,a=t[0],l=[a],h=1,c=t.length;h<c;h++)n=t[h],r=a,o=void 0,s=void 0,o=(i=n)[0]-r[0],s=i[1]-r[1],o*o+s*s>e&&(l.push(n),a=n);return a!==n&&l.push(n),l}(t,i),t=Jn(t,i)}function $n(t,e){return t[0]*e[0]+t[1]*e[1]}function Xn(t,e){const n=e[0],i=e[1],r=Math.sqrt(n*n+i*i);return t[0]=n/r,t[1]=i/r,t}function ti(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t}function ei(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function ni(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function ii(t,e){const n=e[0],i=e[1],r=e[2],o=Math.sqrt(n*n+i*i+r*r);return t[0]=n/o,t[1]=i/o,t[2]=r/o,t}function ri(t,e,n){var i=e[0],r=e[1],o=e[2],s=n[0],a=n[1],l=n[2];return t[0]=r*l-o*a,t[1]=o*s-i*l,t[2]=i*a-r*s,t}const oi=[];function si(t,e,n,i){const r=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(e,n),o=Math.acos(r)*i;return ti(oi,n,e,-r),function(t,e){const n=e[0],i=e[1],r=e[2],o=Math.sqrt(n*n+i*i+r*r);t[0]=n/o,t[1]=i/o,t[2]=r/o}(oi,oi),function(t,e,n){t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}(t,e,Math.cos(o)),ti(t,t,oi,Math.sin(o)),t}function ai(t,e,n,i,r,o,s,a,l,h){const c=s-r,u=a-o,d=(c*(e-o)-u*(t-r))/(u*(n-t)-c*(i-e));return l&&(l[h=h||0]=t+d*(n-t),l[h+1]=e+d*(i-e)),d}function li(t,e,n){if(n-e<3)return 0;let i=0;for(let r=2*(n-1),o=2*e;o<2*n;){const e=t[r],n=t[r+1],s=t[o],a=t[o+1];r=o,o+=2,i+=e*a-s*n}return i}function hi(t,e,n=2){return Nn(t,e,n)}const ci=[],ui=[],di=[];function fi(t,e,n,i,r,o,s,a,l){const h=null!=s;let c,u,d,f=r,p=null;h&&(p=new Uint32Array(i-n));let g=[];for(let r=n;r<i;r++){const y=r===i-1?n:r+1,x=r===n?i-1:r-1,v=t[2*x],m=t[2*x+1],b=t[2*r],_=t[2*r+1],w=t[2*y],M=t[2*y+1];ci[0]=b-v,ci[1]=_-m,ui[0]=w-b,ui[1]=M-_,Xn(ci,ci),Xn(ui,ui),h&&(p[r]=f);let O,A,j=!1;if(a||r!==n)if(a||r!==i-1){ei(di,ui,ci);const t=di[1];di[1]=-di[0],di[0]=t,Xn(di,di);const n=$n(di,ui),i=Math.sqrt(1-n*n),r=o*Math.min(10,1/i),a=o*n<0;if(h&&1/i>s&&a){const t=b+di[0]*o,n=_+di[1]*o,r=Math.acos(i)/2,s=Math.tan(r)*Math.abs(o);e[2*f]=t+di[1]*s,e[2*f+1]=n-di[0]*s,f++,e[2*f]=t-di[1]*s,e[2*f+1]=n+di[0]*s,f++}else O=b+di[0]*r,A=_+di[1]*r,j=!0;if(j){if(l&&null!=c){const t=ai(v,m,c,u,b,_,O,A,g,0);t>=-.01&&t<=1.01&&(e[2*d]=O=g[0],e[2*d+1]=A=g[1])}c=e[2*f]=O,u=e[2*f+1]=A,d=f,f++}}else di[0]=ci[1],di[1]=-ci[0],Xn(di,di),O=b+di[0]*o,A=_+di[1]*o,j=!0;else di[0]=ui[1],di[1]=-ui[0],Xn(di,di),c=e[2*f]=b+di[0]*o,u=e[2*f+1]=_+di[1]*o,d=f,f++}return p}function pi(t,e,n,i,r,o,s,a){const l=null!=s;let h=r,c=null;l&&(c=new Uint32Array(i-n));for(let r=n;r<i;r++){const u=r===i-1?n:r+1,d=r===n?i-1:r-1,f=t[2*d],p=t[2*d+1],g=t[2*r],y=t[2*r+1],x=t[2*u],v=t[2*u+1];if(ci[0]=g-f,ci[1]=y-p,ui[0]=x-g,ui[1]=v-y,Xn(ci,ci),Xn(ui,ui),l&&(c[r]=h),a||r!==n)if(a||r!==i-1){ei(di,ui,ci);const t=di[1];di[1]=-di[0],di[0]=t,Xn(di,di);const n=$n(di,ui),i=Math.sqrt(1-n*n),r=o*Math.min(10,1/i),a=o*n<0;if(l&&1/i>s&&a){const t=g+di[0]*o,n=y+di[1]*o,r=Math.acos(i)/2,s=Math.tan(r)*Math.abs(o);e[2*h]=t+di[1]*s,e[2*h+1]=n-di[0]*s,h++,e[2*h]=t-di[1]*s,e[2*h+1]=n+di[0]*s,h++}else e[2*h]=g+di[0]*r,e[2*h+1]=y+di[1]*r,h++}else di[0]=ci[1],di[1]=-ci[0],Xn(di,di),e[2*h]=g+di[0]*o,e[2*h+1]=y+di[1]*o,h++;else di[0]=ui[1],di[1]=-ui[0],Xn(di,di),e[2*h]=g+di[0]*o,e[2*h+1]=y+di[1]*o,h++}return c}function gi(t,e,n,i,r){const o=null!=i?[]:new Float32Array(t.length);if(fi(t,o,0,e&&e.length?e[0]:t.length/2,0,n,i,r,!0),e)for(let s=0;s<e.length;s++){const a=e[s];fi(t,o,a,e[s+1]||t.length/2,null!=i?o.length/2:a,n,i,r,!1)}return o}function yi(t,e,n,i){for(let r=0;r<Math.floor((i-n)/2);r++)for(let o=0;o<e;o++){const s=(r+n)*e+o,a=(i-r-1)*e+o,l=t[s];t[s]=t[a],t[a]=l}return t}function xi(t,e){let n=t.length/2,i=0,r=e&&e.length?e[0]:n;li(t,i,r)>0&&yi(t,2,i,r);for(let o=1;o<(e?e.length:0)+1;o++)i=e[o-1],r=e[o]||n,li(t,i,r)<0&&yi(t,2,i,r)}function vi(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,null==t.smoothSide&&(t.smoothSide="auto"),null==t.smoothSideThreshold&&(t.smoothSideThreshold=.9),"number"==typeof t.depth&&(t.bevelSize=Math.min(t.bevelSegments>0?t.bevelSize:0,t.depth/2)),t.bevelSize>0||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);const e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){let n=null==t.fitRect.x?e.x||0:t.fitRect.x,i=null==t.fitRect.y?e.y||0:t.fitRect.y,r=t.fitRect.width,o=t.fitRect.height;null==r?null!=o?r=o/e.height*e.width:(r=e.width,o=e.height):null==o&&(o=r/e.width*e.height),t.scale=[r/e.width,o/e.height],t.translate=[(n-e.x)*t.scale[0],(i-e.y)*t.scale[1]]}}const mi=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function bi(t,e,n){let i=0,r=t[e],o=t[e+1];const s=r,a=o;for(let s=e+2;s<n;s+=2){const e=t[s],n=t[s+1];i+=Math.sqrt((e-r)*(e-r)+(n-o)*(n-o)),r=e,o=n}return i+=Math.sqrt((r-s)*(r-s)+(o-a)*(o-a)),i}function _i(t,{vertices:e,topVertices:n,splittedMap:i,depth:r,rect:o},s,a,l,h){const c=a-s,u=h.smoothBevel?1:2,d=Math.min(r/2,h.bevelSize),f=h.bevelSegments,p=l.vertex,g=l.ringPerimeter,y=Math.max(o.width,o.height,r,g);function x(t){const n=(t+1)%c,i=e[2*t],r=e[2*t+1],o=e[2*n],s=e[2*n+1];return i===o&&r===s}if(d>0){const o=[0,0,1],a=[],h=[0,0,-1],g=[];let v=0,m=new Float32Array(c);for(let b=0;b<2;b++){const _=0===b?r-d:d;for(let r=0;r<=f*u;r++){let w,M,O=0;for(let A=0;A<c;A++){const j=2*(A%c+s),S=i?2*i[j/2]:j;a[0]=e[j]-n[S],a[1]=e[j+1]-n[S+1],a[2]=0;const T=Math.sqrt(a[0]*a[0]+a[1]*a[1]);a[0]/=T,a[1]/=T;const C=(Math.floor(r/u)+r%u)/f;0===b?si(g,o,a,C):si(g,a,h,C);const k=0===b?C:1-C,P=d*Math.sin(k*Math.PI/2),L=T*Math.cos(k*Math.PI/2),B=d*T/Math.sqrt(P*P+L*L),z=g[0]*B+n[S],I=g[1]*B+n[S+1],E=g[2]*B+_;if(t.position[3*l.vertex]=z,t.position[3*l.vertex+1]=I,t.position[3*l.vertex+2]=E,A>0&&(O+=Math.sqrt((w-z)*(w-z)+(M-I)*(M-I))),r>0||b>0){let e=3*(l.vertex-c),n=t.position[e],i=t.position[e+1],r=t.position[e+2];m[A]+=Math.sqrt((n-z)*(n-z)+(i-I)*(i-I)+(r-E)*(r-E))}if(t.uv[2*l.vertex]=O/y,t.uv[2*l.vertex+1]=m[A]/y,w=z,M=I,l.vertex++,!x(A)&&(u>1&&r%u||1===u&&r>=1))for(let e=0;e<6;e++){const n=(mi[e][0]+A)%c,i=mi[e][1]+v;t.indices[l.index++]=(i-1)*c+n+p}}v++}}}else for(let n=0;n<2;n++){const i=0===n?r-d:d;let o,a,h=0;for(let n=0;n<c;n++){const r=2*(n%c+s),u=e[r],d=e[r+1];t.position[3*l.vertex]=u,t.position[3*l.vertex+1]=d,t.position[3*l.vertex+2]=i,n>0&&(h+=Math.sqrt((o-u)*(o-u)+(a-d)*(a-d))),t.uv[2*l.vertex]=h/y,t.uv[2*l.vertex+1]=i/y,o=u,a=d,l.vertex++}}const v=d>0?f*u+1:1;for(let e=0;e<c;e++)if(!x(e))for(let n=0;n<6;n++){const i=(mi[n][0]+e)%c,r=mi[n][1]+v;t.indices[l.index++]=(r-1)*c+i+p}}function wi({indices:t,topVertices:e,rect:n,depth:i},r,o,s){if(e.length<=4)return;const a=o.vertex,l=t.length;for(let e=0;e<l;e++)r.indices[o.index++]=a+t[e];const h=Math.max(n.width,n.height);for(let t=0;t<(s.excludeBottom?1:2);t++)for(let s=0;s<e.length;s+=2){const a=e[s],l=e[s+1];r.position[3*o.vertex]=a,r.position[3*o.vertex+1]=l,r.position[3*o.vertex+2]=(1-t)*i,r.uv[2*o.vertex]=(a-n.x)/h,r.uv[2*o.vertex+1]=(l-n.y)/h,o.vertex++}if(!s.excludeBottom){const n=e.length/2;for(let e=0;e<l;e+=3)for(let i=0;i<3;i++)r.indices[o.index++]=a+n+t[e+2-i]}}function Mi(t,e,n,i){const r=null==n||"auto"===n;if(!0===n)return{vertices:t,holes:e};const o=[],s=e&&[],a=t.length/2,l=[],h=[],c=[];let u=0,d=0;const f=(e?e.length:0)+1;for(let n=0;n<f;n++){0===n?d=e&&e.length?e[0]:a:(u=e[n-1],d=e[n]||a);for(let e=u;e<d;e++){const n=t[2*e],s=t[2*e+1],a=e===d-1?u:e+1,f=t[2*a],p=t[2*a+1];if(r){const r=e===u?d-1:e-1,a=t[2*r],g=t[2*r+1];l[0]=a-n,l[1]=g-s,h[0]=f-n,h[1]=p-s,Xn(l,l),Xn(h,h);1-(.5*$n(l,h)+.5)>i?(o.push(n,s),c.push(e)):(o.push(n,s,n,s),c.push(e,e))}else o.push(n,s,n,s),c.push(e,e)}n<f-1&&s&&s.push(o.length/2)}return{vertices:new Float32Array(o),splittedMap:c,holes:s}}function Oi(t,e){let n=0,i=0;for(let r=0;r<t.length;r++){const{indices:o,vertices:s,splittedMap:a,topVertices:l,depth:h}=t[r],c=Math.min(h/2,e.bevelSize)>0?e.bevelSegments:0,u=t[r].holes||[];n+=o.length*(e.excludeBottom?1:2),i+=l.length/2*(e.excludeBottom?1:2);const d=2+2*c;let f=0,p=0;for(let t=0;t<u.length+1;t++){0===t?p=u.length?u[0]:s.length/2:(f=u[t-1],p=u[t]||s.length/2);n+=6*((a?a[p-1]+1:p)-(a?a[f]:f))*(d-1);const r=p-f;i+=r*d+(e.smoothBevel?0:c*r*2)}}const r={position:new Float32Array(3*i),indices:new(i>65535?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*i)},o={vertex:0,index:0,ringPerimeter:0};for(let n=0;n<t.length;n++)wi(t[n],r,o,e);for(let n=0;n<t.length;n++){const{holes:i,vertices:s}=t[n],a=s.length/2;let l=0,h=i&&i.length?i[0]:a;if(o.ringPerimeter=bi(t[n].topVertices,l,h),_i(r,t[n],l,h,o,e),i)for(let s=0;s<i.length;s++)l=i[s],h=i[s+1]||a,o.ringPerimeter=bi(t[n].topVertices,l,h),_i(r,t[n],l,h,o,e)}for(let t=0;t<r.uv.length;t++){const e=r.uv[t];e>0&&Math.round(e)===e?r.uv[t]=1:r.uv[t]=e%1}return r.normal=function(t,e){function n(t,e,n,i){t[0]=e,t[1]=n,t[2]=i}const i=[],r=[],o=[],s=[],a=[],l=[],h=t.length,c=new Float32Array(e.length);for(let u=0;u<h;){const h=3*t[u++],d=3*t[u++],f=3*t[u++];n(i,e[h],e[h+1],e[h+2]),n(r,e[d],e[d+1],e[d+2]),n(o,e[f],e[f+1],e[f+2]),ni(s,i,r),ni(a,r,o),ri(l,s,a);for(let t=0;t<3;t++)c[h+t]=c[h+t]+l[t],c[d+t]=c[d+t]+l[t],c[f+t]=c[f+t]+l[t]}for(var u=0;u<c.length;)n(l,c[u],c[u+1],c[u+2]),ii(l,l),c[u++]=l[0],c[u++]=l[1],c[u++]=l[2];return c}(r.indices,r.position),r.boundingRect=t[0]&&t[0].rect,r}function Ai(t,e,n){const i=n.lineWidth,r=t.length,o=new Float32Array(2*r),s=n.translate||[0,0],a=n.scale||[1,1];for(let e=0,n=0;e<r;e++)o[n++]=t[e][0]*a[0]+s[0],o[n++]=t[e][1]*a[1]+s[1];li(o,0,r)<0&&yi(o,2,0,r);const l=[],h=[],c=n.miterLimit,u=pi(o,h,0,r,0,-i/2,c,!1);yi(o,2,0,r);const d=pi(o,l,0,r,0,-i/2,c,!1),f=(l.length+h.length)/2,p=new Float32Array(2*f);let g=0;const y=h.length/2;for(let t=0;t<h.length;t++)p[g++]=h[t];for(let t=0;t<l.length;t++)p[g++]=l[t];const x=new(f>65535?Uint32Array:Uint16Array)(3*(2*(r-1)+(f-2*r)));let v=0;for(let t=0;t<r-1;t++){const e=t+1;x[v++]=y-1-u[t],x[v++]=y-1-u[t]-1,x[v++]=d[t]+1+y,x[v++]=y-1-u[t],x[v++]=d[t]+1+y,x[v++]=d[t]+y,d[e]-d[t]==2?(x[v++]=d[t]+2+y,x[v++]=d[t]+1+y,x[v++]=y-u[e]-1):u[e]-u[t]==2&&(x[v++]=d[e]+y,x[v++]=y-1-(u[t]+1),x[v++]=y-1-(u[t]+2))}const m=n.bevelSize>0?gi(p,[],n.bevelSize,null,!0):p,b=n.boundingRect,_=Mi(p,null,n.smoothSide,n.smoothSideThreshold);return{vertices:_.vertices,rawVertices:m,splittedMap:_.splittedMap,indices:x,topVertices:m,rect:{x:b.x*a[0]+s[0],y:b.y*a[1]+s[1],width:b.width*a[0],height:b.height*a[1]},depth:"function"==typeof n.depth?n.depth(e):n.depth,holes:[]}}function ji(t,e){const n=[];for(let i=0;i<t.length;i++){const r=t[i],o=[],s=r.length;let a=r[s-1][0],l=r[s-1][1],h=0;for(let t=0;t<s;t++){let n=r[t][0],i=r[t][1];const s=n-a,c=i-l;h+=Math.sqrt(s*s+c*c),h>e&&(o.push(r[t]),h=0),a=n,l=i}o.length>=3&&n.push(o)}return n.length>0?n:null}function Si(t,e){const n=[];for(let i=0;i<t.length;i++){let r=t[i];r=Yn(r,e,!0),r.length>=3&&n.push(r)}return n.length>0?n:null}function Ti(t,e){e=Object.assign({},e);const n=[1/0,1/0],i=[-1/0,-1/0];for(let e=0;e<t.length;e++)ki(t[e][0],n,i);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:i[0]-n[0],height:i[1]-n[1]},vi(e);const r=[],o=e.translate||[0,0],s=e.scale||[1,1],a=e.boundingRect,l={x:a.x*s[0]+o[0],y:a.y*s[1]+o[1],width:a.width*s[0],height:a.height*s[1]},h=Math.min(a.width,a.height)/1e5;for(let n=0;n<t.length;n++){let i=ji(t[n],h);if(!i)continue;const a=e.simplify/Math.max(s[0],s[1]);if(a>0&&(i=Si(i,a)),!i)continue;const{vertices:c,holes:u,dimensions:d}=Nn.flatten(i);for(let t=0;t<c.length;)c[t]=c[t++]*s[0]+o[0],c[t]=c[t++]*s[1]+o[1];if(xi(c,u),2!==d)throw new Error("Only 2D polygon points are supported");const f=e.bevelSize>0?gi(c,u,e.bevelSize,null,!0):c,p=hi(f,u,d),g=Mi(c,u,e.smoothSide,e.smoothSideThreshold);r.push({indices:p,vertices:g.vertices,rawVertices:c,topVertices:f,holes:g.holes,splittedMap:g.splittedMap,rect:l,depth:"function"==typeof e.depth?e.depth(n):e.depth})}return Oi(r,e)}function Ci(t,e){e=Object.assign({},e);const n=[1/0,1/0],i=[-1/0,-1/0];for(let e=0;e<t.length;e++)ki(t[e],n,i);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:i[0]-n[0],height:i[1]-n[1]},vi(e);const r=e.scale||[1,1];null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);const o=[];for(let n=0;n<t.length;n++){let i=t[n];const s=e.simplify/Math.max(r[0],r[1]);s>0&&(i=Yn(i,s,!0)),o.push(Ai(i,n,e))}return Oi(o,e)}function ki(t,e,n){for(let i=0;i<t.length;i++)e[0]=Math.min(t[i][0],e[0]),e[1]=Math.min(t[i][1],e[1]),n[0]=Math.max(t[i][0],n[0]),n[1]=Math.max(t[i][1],n[1])}var Pi=Object.freeze({__proto__:null,triangulate:hi,flatten:function(t){return Nn.flatten(t)},offsetPolygon:gi,extrudePolygon:Ti,extrudePolyline:Ci,extrudeGeoJSON:function(t,e){e=Object.assign({},e);const n=[],i=[],r=[],o=[],s=[1/0,1/0],a=[-1/0,-1/0];for(let e=0;e<t.features.length;e++){const l=t.features[e].geometry;if(l&&l.coordinates)switch(l.type){case"LineString":n.push(l.coordinates),r.push(e),ki(l.coordinates,s,a);break;case"MultiLineString":for(let t=0;t<l.coordinates.length;t++)n.push(l.coordinates[t]),r.push(e),ki(l.coordinates[t],s,a);break;case"Polygon":i.push(l.coordinates),o.push(e),ki(l.coordinates[0],s,a);break;case"MultiPolygon":for(let t=0;t<l.coordinates.length;t++)i.push(l.coordinates[t]),o.push(e),ki(l.coordinates[t][0],s,a)}}e.boundingRect=e.boundingRect||{x:s[0],y:s[1],width:a[0]-s[0],height:a[1]-s[1]};const l=e.depth;return{polyline:Ci(n,Object.assign(e,{depth:function(e){return"function"==typeof l?l(t.features[r[e]]):l}})),polygon:Ti(i,Object.assign(e,{depth:function(e){return"function"==typeof l?l(t.features[o[e]]):l}}))}}});const Li="__maptalks.three.fetchdata__";var Bi;const zi=Math.PI/180,Ii=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02],[.4,.01],[.1,.005],[.05,.002],[.01,.001]],Ei=["mouseout","mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],Ui=new o.Coordinate(0,0),Fi=new o.Point(0,0),Vi="__webglFramebuffer";class Ri extends o.CanvasLayer{constructor(t,e){super(t,e),this._animationBaseObjectMap={},this._needsUpdate=!0,this._mousemoveTimeOut=0,this._mousedownTime=0,this._baseObjects=[],this._delayMeshes=[],this.type="ThreeLayer"}isMercator(){const t=this.getMap();if(!t)return!1;const e=t.getSpatialReference(),n=e._projection,i=e._resolutions;return!!(n&&"EPSG:3857"===n.code&&i&&i.length&&156543===Math.floor(i[0])&&t.getGLRes)}isRendering(){const t=this.getMap();return!!t&&(t.isInteracting()||t.isAnimating())}prepareToDraw(...t){}draw(t,e,n,i,r,o){this.renderScene(o,this)}drawOnInteracting(t,e,n,i,r,o,s){this.renderScene(s,this)}coordinateToVector3(t,e=0,n){const i=this.getMap();if(!i)return null;const r=Array.isArray(t);r?(Ui.x=t[0],Ui.y=t[1]):t instanceof o.Coordinate||(t=new o.Coordinate(t));const a=Hi(i),l=Qi(i,r?Ui:t,a,Fi);return n&&(n.x=l.x,n.y=l.y,n.z=e),new s.Vector3(l.x,l.y,e)}coordinatiesToGLFloatArray(t,e){const n=this.getMap();if(!n)return null;const i=Hi(n),r=t.length,s=new Float32Array(2*r),a=new Float32Array(3*r);for(let l=0;l<r;l++){let r=t[l];const h=Array.isArray(r);h?(Ui.x=r[0],Ui.y=r[1]):r instanceof o.Coordinate||(r=new o.Coordinate(r));const c=Qi(n,h?Ui:r,i,Fi);c.x-=e.x,c.y-=e.y;const u=2*l;s[u]=c.x,s[u+1]=c.y;const d=3*l;a[d]=c.x,a[d+1]=c.y,a[d+2]=0}return{positions:a,positons2d:s}}coordinatiesToGLArray(t,e){const n=this.getMap();if(!n)return null;const i=Hi(n),r=t.length,s=new Array(r);for(let a=0;a<r;a++){let r=t[a];const l=Array.isArray(r);l?(Ui.x=r[0],Ui.y=r[1]):r instanceof o.Coordinate||(r=new o.Coordinate(r));const h=Qi(n,l?Ui:r,i,Fi);h.x-=e.x,h.y-=e.y,s[a]=[h.x,h.y]}return s}distanceToVector3(t,e,n){if(0===t&&0===e||!o.Util.isNumber(t)||!o.Util.isNumber(e))return new s.Vector3(0,0,0);const i=this.getMap(),r=Hi(i);let a=n||i.getCenter();a instanceof o.Coordinate||(a=new o.Coordinate(a));const l=i.locate(a,t,e),h=Qi(i,a,r),c=Qi(i,l,r),u=Math.abs(c.x-h.x)*o.Util.sign(t),d=Math.abs(c.y-h.y)*o.Util.sign(e);return new s.Vector3(u,d,0)}altitudeToVector3(t,e,n,i){if(0===t||!o.Util.isNumber(t))return new s.Vector3(0,0,0);const r=this.getMap();if(r.altitudeToPoint){const e=Hi(r);let n=r.altitudeToPoint(t,e);return t<0&&n>0&&(n=-n),i?(i.x=n,i.y=n,i.z=0,i):new s.Vector3(n,n,0)}return this.distanceToVector3(t,t,n)}toShape(t){if(!t)return null;if(t instanceof o.MultiPolygon)return t.getGeometries().map((t=>this.toShape(t)));const e=t.getCenter(),n=this.coordinateToVector3(e),i=t.getShell().map((t=>{const e=this.coordinateToVector3(t).sub(n);return new s.Vector2(e.x,e.y)})),r=new s.Shape(i),a=t.getHoles();return a&&a.length>0&&(r.holes=a.map((t=>{const e=t.map((t=>{const e=this.coordinateToVector3(t).sub(n);return new s.Vector2(e.x,e.y)}));return new s.Shape(e)}))),r}toExtrudeMesh(t,e,n,i){if(!t)return null;if(t instanceof o.MultiPolygon)return t.getGeometries().map((t=>this.toExtrudeMesh(t,e,n,i)));const r=t.getCoordinates();r.forEach((t=>{for(let e=t.length-1;e>=1;e--)t[e].equals(t[e-1])&&t.splice(e,1)})),t.setCoordinates(r);const a=this.toShape(t),l=this.coordinateToVector3(t.getCenter());i=o.Util.isNumber(i)?i:e,i=this.altitudeToVector3(i,i).x;const h=this.altitudeToVector3(e,e).x,c={bevelEnabled:!1,bevelSize:1};c[parseInt(s.REVISION)>=93?"depth":"amount"]=i;const u=new s.ExtrudeGeometry(a,c);let d=u;s.BufferGeometry.prototype.fromGeometry&&(d=new s.BufferGeometry,d.fromGeometry(u));const f=new s.Mesh(d,n);return f.position.set(l.x,l.y,h-i),f}toExtrudePolygon(t,e,n){return new Yt(t,e,n,this)}toBar(t,e,n){return new Ht(t,e,n,this)}toLine(t,e,n){return new Nt(t,e,n,this)}toExtrudeLine(t,e,n){return new Kt(t,e,n,this)}toModel(t,e){return new Xt(t,e,this)}toExtrudeLineTrail(t,e,n){return new he(t,e,n,this)}toExtrudePolygons(t,e,n){return new ge(t,e,n,this)}toPoint(t,e,n){return new be(t,e,n,this)}toPoints(t,e,n){return new je(t,e,n,this)}toBars(t,e,n){return new Te(t,e,n,this)}toExtrudeLines(t,e,n){return new ke(t,e,n,this)}toLines(t,e,n){return new Le(t,e,n,this)}toThreeVectorTileLayer(t,e,n){return new De(t,e,n,this)}toTerrain(t,e,n){return new Ye(t,e,n,this)}toTerrainVectorTileLayer(t,e,n){return new Xe(t,e,n,this)}toHeatMap(t,e,n){return new ln(t,e,n,this)}toFatLine(t,e,n){return new fn(t,e,n,this)}toFatLines(t,e,n){return new gn(t,e,n,this)}toBox(t,e,n){return new xn(t,e,n,this)}toBoxs(t,e,n){return new mn(t,e,n,this)}getBaseObjects(){return this.getMeshes().filter((t=>t instanceof m))}getMeshes(){const t=this.getScene();if(!t)return[];const e=[];for(let n=0,i=t.children.length;n<i;n++){const i=t.children[n];i instanceof s.Object3D&&!(i instanceof s.Camera)&&e.push(i.__parent||i)}return e}clear(){return this.clearMesh()}clearMesh(){const t=this.getScene();if(!t)return this;for(let e=t.children.length-1;e>=0;e--){const n=t.children[e];if(n instanceof s.Object3D&&!(n instanceof s.Camera)){t.remove(n);const e=n.__parent;e&&e instanceof m&&(e.isAdd=!1,e.options.layer=null,e._fire("remove",{target:e}),delete this._animationBaseObjectMap[n.uuid],e._hideUI())}}return this}lookAt(t){const e=this._getRenderer();return e&&e.context.lookAt(t),this}getCamera(){const t=this._getRenderer();return t?t.camera:null}getScene(){const t=this._getRenderer();return t?t.scene:null}renderScene(t,e){const n=this._getRenderer();return n&&(n.clearCanvas(),n.renderScene(t),e||n.setToRedraw()),this}loop(t=!1){const e=this._delayMeshes;if(!e.length)return;const n=this.getMap();if(!n||n.isAnimating()||n.isInteracting())return;const i=this.options.loopRenderCount||50,r=e.slice(0,i);r&&this.addMesh(r,t),e.splice(0,i)}renderPickScene(){const t=this._getRenderer();if(t){const e=t.pick;e&&e.pick(this._containerPoint)}return this}getThreeRenderer(){const t=this._getRenderer();return t?t.context:null}getPick(){const t=this._getRenderer();return t?t.pick:null}delayAddMesh(t){if(!t)return this;Array.isArray(t)||(t=[t]);for(let e=0,n=t.length;e<n;e++)this._delayMeshes.push(t[e]);return this}addMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const n=this.getScene();if(t.forEach((t=>{t instanceof m?(n.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t.options.layer=this,t._fire("add",{target:t})),t._animation&&o.Util.isFunction(t._animation)&&(this._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof s.Object3D&&n.add(t)})),this._zoomend(),e){const t=this._getRenderer();t&&t.setToRedraw()}return this}removeMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const n=this.getScene();if(t.forEach((t=>{if(t instanceof m){n.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t.options.layer=null,t._fire("remove",{target:t}),t._hideUI()),t._animation&&o.Util.isFunction(t._animation)&&delete this._animationBaseObjectMap[t.getObject3d().uuid];const e=this._delayMeshes;if(e.length)for(let n=0,i=e.length;n<i;n++)if(e[n]===t){e.splice(n,1);break}}else t instanceof s.Object3D&&n.remove(t)})),e){const t=this._getRenderer();t&&t.setToRedraw()}return this}_initRaycaster(){return this._raycaster||(this._raycaster=new s.Raycaster,this._mouse=new s.Vector2),this}getRaycaster(){return this._raycaster}identify(t,e){if(!t)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(t)&&(t=new o.Coordinate(t)),!(t instanceof o.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];const n=this.getMap().coordToContainerPoint(t);this._containerPoint=n;const{x:i,y:r}=n;this._initRaycaster(),this.fire("identify",{coordinate:t,options:e});const l=this._raycaster,h=this._mouse,c=this.getCamera(),u=this.getScene(),d=this.getMap().getSize();if(!u)return[];const f=d.width,p=d.height;h.x=i/f*2-1,h.y=-r/p*2+1,l.setFromCamera(h,c),l.layers&&l.layers.enableAll&&l.layers.enableAll(),function(t,e){a>113?t.params.Line.threshold=e:t.linePrecision=e}(l,this._getLinePrecision(this.getMap().getResolution()));const g=[],y=[];u.children.forEach((t=>{const e=t.__parent;if(e&&e.getOptions){const n=e;n.getOptions().interactive&&n.isVisible()&&(n.identify&&o.Util.isFunction(n.identify)?y.push(n):g.push(t))}else(t instanceof s.Mesh||t instanceof s.Group)&&g.push(t)}));let x=[];const v=l.intersectObjects(g,!0);v&&Array.isArray(v)&&v.length&&(x=v.map((t=>{let e=t.object;const n=t.instanceId;e=this._recursionMesh(e)||{};const i=e.__parent||e;return i.faceIndex=t.faceIndex,i.index=t.index,i.intersect=t,o.Util.isNumber(n)&&(i.instanceId=n),i}))),this.renderPickScene(),y.length&&y.forEach((e=>{e.identify(t)&&x.push(e)}));const m=x.length;for(let t=0;t<m;t++)if(x[t])for(let e=t+1;e<m;e++)x[t]===x[e]&&x.splice(e,1);const b=(e=o.Util.extend({},e)).count;return o.Util.isNumber(b)&&b>0?x.slice(0,b):x}_recursionMesh(t){for(;t&&t.parent!==this.getScene();)t=t.parent;return t}_getLinePrecision(t=10){for(let e=0,n=Ii.length;e<n;e++){const[n,i]=Ii[e];if(t>n)return i}return.01}_identifyBaseObjectEvents(t){if(!this.options.geometryEvents)return this;const e=this.map||this.getMap();if(e.isInteracting()||!e.options.geometryEvents||e._ignoreEvent(t))return this;const n=t.type,i=e._getEventParams?e._getEventParams(t):this._getEventParams(t);i.type=n;const{type:r,coordinate:s}=i,a=o.Util.now();if(this._mousemoveTimeOut&&"mousemove"===r&&a-this._mousemoveTimeOut<64)return this;this._mousemoveTimeOut=a,"mousedown"!==r&&"touchstart"!==r||(this._mousedownTime=o.Util.now());let l=!1;if("click"===r||"touchend"===r){const t=e.options.clickTimeThreshold||280;l=o.Util.now()-this._mousedownTime<t}if("click"===r&&!l)return this;const h=this.options.identifyCountOnEvent;let c=Math.max(0,o.Util.isNumber(h)?h:0);0===c&&(c=1/0);const u=t=>{const e=[];this._baseObjects&&this._baseObjects.forEach((n=>{let i=!0;t.forEach((t=>{n===t&&(i=!1)})),i&&e.push(n)})),e.forEach((t=>{t&&t instanceof m&&(t.getSelectMesh?t.isHide||(t._mouseover=!1,t.fire("mouseout",Object.assign({},i,{target:t,type:"mouseout",selectMesh:null})),t.closeToolTip()):(t._mouseover=!1,t.fire("mouseout",Object.assign({},i,{target:t,type:"mouseout"})),t.closeToolTip()))}))};if("mouseout"===r)return u([]),this._baseObjects=[],this;const d=this.identify(s,{count:c}),f=this.getScene();if(0===d.length&&f)for(let t=0,e=f.children.length;t<e;t++){const e=(f.children[t]||{}).__parent;e&&e.fire("empty",Object.assign({},i,{target:e}))}function p(t,e){e=e||r;const n=t.getInfoWindow();n&&!n._owner&&n.addTo(t);((n?n.options:{}).autoOpenOn||"click")===e&&(t.openInfoWindow(s),t.fire("showinfowindow",{infoWindow:n}))}if("mousemove"===r?(u(d),d.forEach((t=>{if(t instanceof m){t._mouseover||(t.fire("mouseover",Object.assign({},i,{target:t,type:"mouseover",selectMesh:t.getSelectMesh?t.getSelectMesh():null})),t._mouseover=!0,p(t,"mouseover")),t.fire(r,Object.assign({},i,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null}));const e=t.getToolTip();e&&!e._owner&&e.addTo(t),t.openToolTip(s),p(t)}})),this._baseObjects=d):d.forEach((t=>{t instanceof m&&(t.fire(r,Object.assign({},i,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),p(t))})),"touchend"===r&&l){const e=o.Util.extend({},i,{domEvent:t});d.forEach((t=>{t instanceof m&&(t.fire("click",Object.assign({},e,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),p(t,"click"))}))}return this}_getEventParams(t){const e=this.getMap(),n={domEvent:t};if(!e)return n;const i=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(i){const t=(0,o.DomUtil.getEventContainerPoint)(i,e._containerDOM);n.coordinate=e.containerPointToCoordinate(t),n.containerPoint=t,n.viewPoint=e.containerPointToViewPoint(t),n.pont2d=e._containerPointToPoint(t)}return n}_zoomend(){const t=this.getScene();if(!t)return;const e=this.getMap().getZoom();t.children.forEach((t=>{const n=t.__parent;if(n&&n.getOptions){const t=n;t.zoomChange&&o.Util.isFunction(t.zoomChange)&&t.zoomChange(e);const i=t.getMinZoom(),r=t.getMaxZoom();e<i||e>r?(t.isVisible()&&(t.getObject3d().visible=!1),t._zoomVisible=!1):i<=e&&e<=r&&(t._visible&&(t.getObject3d().visible=!0),t._zoomVisible=!0)}}))}_getGeometryEventMapPanel(){const t=this.map||this.getMap();return t._panels.allLayers||t._containerDOM}onAdd(){super.onAdd();const t=this.map||this.getMap();if(!t)return this;const e=this._getGeometryEventMapPanel();return this._identifyBaseObjectEventsThis||(this._identifyBaseObjectEventsThis=this._identifyBaseObjectEvents.bind(this)),this._zoomendThis||(this._zoomendThis=this._zoomend.bind(this)),o.DomUtil.on(e,Ei.join(" "),this._identifyBaseObjectEventsThis,this),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),t.on("zooming zoomend",this._zoomendThis,this),this}onRemove(){super.onRemove();const t=this.map||this.getMap();if(!t)return this;const e=this._getGeometryEventMapPanel();return o.DomUtil.off(e,Ei.join(" "),this._identifyBaseObjectEventsThis,this),t.off("zooming zoomend",this._zoomendThis,this),this.clear(),this}_callbackBaseObjectAnimation(){const t=this;if(t._animationBaseObjectMap)for(const e in t._animationBaseObjectMap){t._animationBaseObjectMap[e]._animation()}return this}_getFovRatio(){const t=this.getMap().getFov();return Math.tan(t/2*zi)}}Ri.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,geometryEvents:!0,identifyCountOnEvent:0,forceRenderOnZooming:!0,loopRenderCount:50});const Gi={bloom:!0};class Zi extends o.renderer.CanvasLayerRenderer{constructor(){super(...arguments),this._renderTime=0,this._renderTarget=null}getPrepareParams(){return[this.scene,this.camera]}getDrawParams(){return[this.scene,this.camera]}_drawLayer(){super._drawLayer.apply(this,arguments)}hitDetect(){return!1}createCanvas(){super.createCanvas(),this.createContext()}createContext(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0,preserveDrawingBuffer:!1};t.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)}_initThreeRenderer(){this.matrix4=new s.Matrix4;const t=new s.WebGLRenderer({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new s.Color(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),this.context=t;const e=this.scene=new s.Scene,n=this.layer.getMap(),i=n.getFov()*Math.PI/180,r=this.camera=new s.PerspectiveCamera(i,n.width/n.height,n.cameraNear,n.cameraFar);r.matrixAutoUpdate=!1,this._syncCamera(),e.add(r),this.pick=new un(this.layer),St.star()}onCanvasCreate(){super.onCanvasCreate()}resizeCanvas(t){if(!this.canvas)return;let e,n=this.getMap();e=t||n.getSize();const i=n.getDevicePixelRatio?n.getDevicePixelRatio():o.Browser.retina?2:1,r=this.canvas,{width:s,height:a,cssWidth:l,cssHeight:h}=o.Util.calCanvasSize(e,i);if(!this.layer._canvas||r.style.width===l&&r.style.height===h||(r.style.width=l,r.style.height=h),r.width===s&&r.height===a)return this;r.width=s,r.height=a,this.context.setSize(r.width,r.height)}clearCanvas(){this.canvas&&this.context.clear()}prepareCanvas(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null}renderScene(t){if(this.layer._callbackBaseObjectAnimation(),this._syncCamera(),t&&t.renderTarget){const{width:e,height:n}=t.renderTarget.fbo;this._renderTarget?(this._renderTarget.viewport.set(0,0,e,n),this._renderTarget.scissor.set(0,0,e,n)):(this._renderTarget=new s.WebGLRenderTarget(e,n,{depthBuffer:!1}),this.context.setRenderTarget(this._renderTarget),this.context.render(this.scene,this.camera));const i=this.context.properties.get(this._renderTarget),r=i[Vi];i[Vi]=t.renderTarget.getFramebuffer(t.renderTarget.fbo),this.context.setRenderTarget(this._renderTarget);const o=1===t.bloom&&t.sceneFilter,a=this.scene.children||[];let l=!1;if(o){const e=t.sceneFilter;l=e(Gi);for(let t=0,n=a.length;t<n;t++){if(!a[t]||!a[t].layers)continue;const n=a[t].__parent;a[t].bloom=!1,n&&(a[t].bloom=n.bloom);let i=0;(a[t]&&e(a[t])||!n)&&l&&(i=1),a[t].__layer!==i&&(Di(a[t],i),a[t].__layer=i)}}else for(let t=0,e=a.length;t<e;t++)a[t]&&a[t].layers&&0!==a[t].__layer&&(Di(a[t],0),a[t].__layer=0);this.camera.layers.set(l?1:0),this.context.render(this.scene,this.camera),i[Vi]=r}else this.context.render(this.scene,this.camera);this.context.setRenderTarget(null),this.completeRender()}remove(){delete this._drawContext,this._renderTarget&&(this._renderTarget.dispose(),delete this._renderTarget),super.remove()}_syncCamera(){const t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,this.matrix4.invert?e.projectionMatrixInverse.elements=this.matrix4.copy(e.projectionMatrix).invert().elements:e.projectionMatrixInverse&&(e.projectionMatrixInverse.elements=this.matrix4.getInverse(e.projectionMatrix).elements)}_createGLContext(t,e){const n=["webgl2","webgl","experimental-webgl"];let i=null;for(let r=0;r<n.length;++r){try{i=t.getContext(n[r],e)}catch(t){}if(i)break}return i}}function Di(t,e){if(!t)return;t.layers&&t.layers.set(e);const n=t.children;if(n&&n.length)for(let t=0,i=n.length;t<i;t++)Di(n[t],e)}function Hi(t){return t.getGLRes?t.getGLRes():t.getGLZoom()}function Qi(t,e,n,i){return t.coordToPointAtRes?t.coordToPointAtRes(e,n,i):t.coordinateToPoint(e,n,i)}Ri.registerRenderer("gl",Zi),o.registerWorkerAdapter&&(o.registerWorkerAdapter("__maptalks.three__",'(function(n){"use strict";\n/*!\n   * poly-extrude v0.1.0\n    */var t={exports:{}};function r(n,t,r){r=r||2;var i,o,u,v,s,l,x,c=t&&t.length,d=c?t[0]*r:n.length,g=e(n,0,d,r,!0),y=[];if(!g||g.next===g.prev)return y;if(c&&(g=function(n,t,r,i){var a,o,u,v=[];for(a=0,o=t.length;a<o;a++)(u=e(n,t[a]*i,a<o-1?t[a+1]*i:n.length,i,!1))===u.next&&(u.steiner=!0),v.push(p(u));for(v.sort(h),a=0;a<v.length;a++)r=f(v[a],r);return r}(n,t,g,r)),n.length>80*r){i=u=n[0],o=v=n[1];for(var m=r;m<d;m+=r)(s=n[m])<i&&(i=s),(l=n[m+1])<o&&(o=l),s>u&&(u=s),l>v&&(v=l);x=0!==(x=Math.max(u-i,v-o))?32767/x:0}return a(g,y,r,i,o,x,0),y}function e(n,t,r,e,i){var a,o;if(i===z(n,t,r,e)>0)for(a=t;a<r;a+=e)o=Z(a,n[a],n[a+1],o);else for(a=r-e;a>=t;a-=e)o=Z(a,n[a],n[a+1],o);return o&&y(o,o.next)&&(F(o),o=o.next),o}function i(n,t){if(!n)return n;t||(t=n);var r,e=n;do{if(r=!1,e.steiner||!y(e,e.next)&&0!==g(e.prev,e,e.next))e=e.next;else{if(F(e),(e=t=e.prev)===e.next)break;r=!0}}while(r||e!==t);return t}function a(n,t,r,e,h,f,l){if(n){!l&&f&&function(n,t,r,e){var i=n;do{0===i.z&&(i.z=x(i.x,i.y,t,r,e)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==n);i.prevZ.nextZ=null,i.prevZ=null,function(n){var t,r,e,i,a,o,u,v,s=1;do{for(r=n,n=null,a=null,o=0;r;){for(o++,e=r,u=0,t=0;t<s&&(u++,e=e.nextZ);t++);for(v=s;u>0||v>0&&e;)0!==u&&(0===v||!e||r.z<=e.z)?(i=r,r=r.nextZ,u--):(i=e,e=e.nextZ,v--),a?a.nextZ=i:n=i,i.prevZ=a,a=i;r=e}a.nextZ=null,s*=2}while(o>1)}(i)}(n,e,h,f);for(var p,c,d=n;n.prev!==n.next;)if(p=n.prev,c=n.next,f?u(n,e,h,f):o(n))t.push(p.i/r|0),t.push(n.i/r|0),t.push(c.i/r|0),F(n),n=c.next,d=c.next;else if((n=c)===d){l?1===l?a(n=v(i(n),t,r),t,r,e,h,f,2):2===l&&s(n,t,r,e,h,f):a(i(n),t,r,e,h,f,1);break}}}function o(n){var t=n.prev,r=n,e=n.next;if(g(t,r,e)>=0)return!1;for(var i=t.x,a=r.x,o=e.x,u=t.y,v=r.y,s=e.y,h=i<a?i<o?i:o:a<o?a:o,f=u<v?u<s?u:s:v<s?v:s,l=i>a?i>o?i:o:a>o?a:o,x=u>v?u>s?u:s:v>s?v:s,p=e.next;p!==t;){if(p.x>=h&&p.x<=l&&p.y>=f&&p.y<=x&&c(i,u,a,v,o,s,p.x,p.y)&&g(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function u(n,t,r,e){var i=n.prev,a=n,o=n.next;if(g(i,a,o)>=0)return!1;for(var u=i.x,v=a.x,s=o.x,h=i.y,f=a.y,l=o.y,p=u<v?u<s?u:s:v<s?v:s,d=h<f?h<l?h:l:f<l?f:l,y=u>v?u>s?u:s:v>s?v:s,m=h>f?h>l?h:l:f>l?f:l,w=x(p,d,t,r,e),M=x(y,m,t,r,e),b=n.prevZ,A=n.nextZ;b&&b.z>=w&&A&&A.z<=M;){if(b.x>=p&&b.x<=y&&b.y>=d&&b.y<=m&&b!==i&&b!==o&&c(u,h,v,f,s,l,b.x,b.y)&&g(b.prev,b,b.next)>=0)return!1;if(b=b.prevZ,A.x>=p&&A.x<=y&&A.y>=d&&A.y<=m&&A!==i&&A!==o&&c(u,h,v,f,s,l,A.x,A.y)&&g(A.prev,A,A.next)>=0)return!1;A=A.nextZ}for(;b&&b.z>=w;){if(b.x>=p&&b.x<=y&&b.y>=d&&b.y<=m&&b!==i&&b!==o&&c(u,h,v,f,s,l,b.x,b.y)&&g(b.prev,b,b.next)>=0)return!1;b=b.prevZ}for(;A&&A.z<=M;){if(A.x>=p&&A.x<=y&&A.y>=d&&A.y<=m&&A!==i&&A!==o&&c(u,h,v,f,s,l,A.x,A.y)&&g(A.prev,A,A.next)>=0)return!1;A=A.nextZ}return!0}function v(n,t,r){var e=n;do{var a=e.prev,o=e.next.next;!y(a,o)&&m(a,e,e.next,o)&&b(a,o)&&b(o,a)&&(t.push(a.i/r|0),t.push(e.i/r|0),t.push(o.i/r|0),F(e),F(e.next),e=n=o),e=e.next}while(e!==n);return i(e)}function s(n,t,r,e,o,u){var v=n;do{for(var s=v.next.next;s!==v.prev;){if(v.i!==s.i&&d(v,s)){var h=A(v,s);return v=i(v,v.next),h=i(h,h.next),a(v,t,r,e,o,u,0),void a(h,t,r,e,o,u,0)}s=s.next}v=v.next}while(v!==n)}function h(n,t){return n.x-t.x}function f(n,t){var r=function(n,t){var r,e=t,i=n.x,a=n.y,o=-1/0;do{if(a<=e.y&&a>=e.next.y&&e.next.y!==e.y){var u=e.x+(a-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(u<=i&&u>o&&(o=u,r=e.x<e.next.x?e:e.next,u===i))return r}e=e.next}while(e!==t);if(!r)return null;var v,s=r,h=r.x,f=r.y,x=1/0;e=r;do{i>=e.x&&e.x>=h&&i!==e.x&&c(a<f?i:o,a,h,f,a<f?o:i,a,e.x,e.y)&&(v=Math.abs(a-e.y)/(i-e.x),b(e,n)&&(v<x||v===x&&(e.x>r.x||e.x===r.x&&l(r,e)))&&(r=e,x=v)),e=e.next}while(e!==s);return r}(n,t);if(!r)return t;var e=A(r,n);return i(e,e.next),i(r,r.next)}function l(n,t){return g(n.prev,n,t.prev)<0&&g(t.next,n,n.next)<0}function x(n,t,r,e,i){return(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-r)*i|0)|n<<8))|n<<4))|n<<2))|n<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-e)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function p(n){var t=n,r=n;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==n);return r}function c(n,t,r,e,i,a,o,u){return(i-o)*(t-u)>=(n-o)*(a-u)&&(n-o)*(e-u)>=(r-o)*(t-u)&&(r-o)*(a-u)>=(i-o)*(e-u)}function d(n,t){return n.next.i!==t.i&&n.prev.i!==t.i&&!function(n,t){var r=n;do{if(r.i!==n.i&&r.next.i!==n.i&&r.i!==t.i&&r.next.i!==t.i&&m(r,r.next,n,t))return!0;r=r.next}while(r!==n);return!1}(n,t)&&(b(n,t)&&b(t,n)&&function(n,t){var r=n,e=!1,i=(n.x+t.x)/2,a=(n.y+t.y)/2;do{r.y>a!=r.next.y>a&&r.next.y!==r.y&&i<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(e=!e),r=r.next}while(r!==n);return e}(n,t)&&(g(n.prev,n,t.prev)||g(n,t.prev,t))||y(n,t)&&g(n.prev,n,n.next)>0&&g(t.prev,t,t.next)>0)}function g(n,t,r){return(t.y-n.y)*(r.x-t.x)-(t.x-n.x)*(r.y-t.y)}function y(n,t){return n.x===t.x&&n.y===t.y}function m(n,t,r,e){var i=M(g(n,t,r)),a=M(g(n,t,e)),o=M(g(r,e,n)),u=M(g(r,e,t));return i!==a&&o!==u||(!(0!==i||!w(n,r,t))||(!(0!==a||!w(n,e,t))||(!(0!==o||!w(r,n,e))||!(0!==u||!w(r,t,e)))))}function w(n,t,r){return t.x<=Math.max(n.x,r.x)&&t.x>=Math.min(n.x,r.x)&&t.y<=Math.max(n.y,r.y)&&t.y>=Math.min(n.y,r.y)}function M(n){return n>0?1:n<0?-1:0}function b(n,t){return g(n.prev,n,n.next)<0?g(n,t,n.next)>=0&&g(n,n.prev,t)>=0:g(n,t,n.prev)<0||g(n,n.next,t)<0}function A(n,t){var r=new P(n.i,n.x,n.y),e=new P(t.i,t.x,t.y),i=n.next,a=t.prev;return n.next=t,t.prev=n,r.next=i,i.prev=r,e.next=r,r.prev=e,a.next=e,e.prev=a,e}function Z(n,t,r,e){var i=new P(n,t,r);return e?(i.next=e.next,i.prev=e,e.next.prev=i,e.next=i):(i.prev=i,i.next=i),i}function F(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function P(n,t,r){this.i=n,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function z(n,t,r,e){for(var i=0,a=t,o=r-e;a<r;a+=e)i+=(n[o]-n[a])*(n[a+1]+n[o+1]),o=a;return i}t.exports=r,t.exports.default=r,r.deviation=function(n,t,r,e){var i=t&&t.length,a=i?t[0]*r:n.length,o=Math.abs(z(n,0,a,r));if(i)for(var u=0,v=t.length;u<v;u++){var s=t[u]*r,h=u<v-1?t[u+1]*r:n.length;o-=Math.abs(z(n,s,h,r))}var f=0;for(u=0;u<e.length;u+=3){var l=e[u]*r,x=e[u+1]*r,p=e[u+2]*r;f+=Math.abs((n[l]-n[p])*(n[x+1]-n[l+1])-(n[l]-n[x])*(n[p+1]-n[l+1]))}return 0===o&&0===f?0:Math.abs((f-o)/o)},r.flatten=function(n){for(var t=n[0][0].length,r={vertices:[],holes:[],dimensions:t},e=0,i=0;i<n.length;i++){for(var a=0;a<n[i].length;a++)for(var o=0;o<t;o++)r.vertices.push(n[i][a][o]);i>0&&(e+=n[i-1].length,r.holes.push(e))}return r};var I=t.exports;function E(n){for(var t,r,e=0,i=1,a=n.length;i<a;)t=r||n[0],e+=((r=n[i])[0]-t[0])*(r[1]+t[1]),i++;return e>0}function L(n,t,r){return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],n}function H(n,t){var r=t[0],e=t[1],i=t[2],a=Math.sqrt(r*r+e*e+i*i)||1;return n[0]=r/a,n[1]=e/a,n[2]=i/a,n}function U(n,t){function r(n,t,r,e){n[0]=t,n[1]=r,n[2]=e}for(var e,i,a,o,u,v,s,h,f,l=[],x=[],p=[],c=[],d=[],g=[],y=n.length,m=new Float32Array(t.length),w=0;w<y;){var M=3*n[w],b=3*n[w+1],A=3*n[w+2];r(l,t[M],t[M+1],t[M+2]),r(x,t[b],t[b+1],t[b+2]),r(p,t[A],t[A+1],t[A+2]),L(d,p,x),L(c,l,x),e=g,a=c,o=void 0,u=void 0,v=void 0,s=void 0,h=void 0,f=void 0,o=(i=d)[0],u=i[1],v=i[2],s=a[0],h=a[1],f=a[2],e[0]=u*f-v*h,e[1]=v*s-o*f,e[2]=o*h-u*s;for(var Z=0;Z<3;Z++)m[M+Z]+=g[Z],m[b+Z]+=g[Z],m[A+Z]+=g[Z];w+=3}for(var F=0,P=m.length;F<P;)r(g,m[F],m[F+1],m[F+2]),H(g,g),m[F]=g[0]||0,m[F+1]=g[1]||0,m[F+2]=g[2]||0,F+=3;return m}function j(n){if(1===n.length)return{position:n[0].position,normal:n[0].normal,uv:n[0].uv,indices:n[0].indices,results:n};for(var t=0,r=0,e=0,i=n.length;e<i;e++){var a=n[e],o=a.position,u=a.indices;t+=o.length,r+=u.length}for(var v={position:new Float32Array(t),normal:new Float32Array(t),uv:new Float32Array(t/3*2),indices:new Uint32Array(r),results:n},s=0,h=0,f=0,l=0,x=0,p=n.length;x<p;x++){var c=n[x],d=c.position,g=c.indices,y=c.normal,m=c.uv;v.position.set(d,s),v.normal.set(y,s),v.uv.set(m,l);for(var w=0,M=g.length;w<M;){var b=g[w]+h;v.indices[f]=b,f++,w++}l+=m.length,s+=d.length,h+=d.length/3}return v}function O(n){return 180*n/Math.PI}function S(n){return n/180*Math.PI}function W(n,t,r,e,i,a){var o=3*r,u=3*e,v=3*i,s=3*a,h=t[o],f=t[o+1],l=t[o+2],x=t[u],p=t[u+1],c=t[u+2],d=t[v],g=t[v+1],y=t[v+2],m=t[s],w=t[s+1],M=t[s+2];Math.abs(f-p)<Math.abs(h-x)?(n.push(h,1-l),n.push(x,1-c),n.push(d,1-y),n.push(m,1-M)):(n.push(f,1-l),n.push(p,1-c),n.push(g,1-y),n.push(w,1-M))}function k(n,t){t=Object.assign({},{depth:2},t);var r=n.map((function(n){for(var r=0,e=n.length;r<e;r++){var i=n[r];B(i),0===r?E(i)||(n[r]=i.reverse()):E(i)&&(n[r]=i.reverse()),V(i)&&i.splice(i.length-1,1)}var a=function(n,t){for(var r=function(n){var t=0,r=0,e=n.length;for(;r<e;)t+=n[r].length,r++;return t}(n),e=n.length,i=[],a=new Float32Array(2*r),o=[],u=[],v=3*r,s=2*r,h=t.depth,f=0,l=0,x=0,p=0;p<e;p++){var c=n[p];p>0&&i.push(f/2);for(var d=0,g=c.length;d<g;){var y=c[d],m=y[0],w=y[1];a[f++]=m,a[f++]=w,o[l]=m,o[l+1]=w,o[l+2]=h,o[v+l]=m,o[v+l+1]=w,o[v+l+2]=0,u[x]=m,u[x+1]=w,u[s+x]=m,u[s+x+1]=w,l+=3,x+=2,d++}}return{flatVertices:a,holes:i,points:o,count:r,uvs:u}}(n,t);return a.polygon=n,function(n,t){for(var r=[],e=n.count,i=0,a=t.length;i<a;i+=3){var o=t[i],u=t[i+1],v=t[i+2];r[i]=o,r[i+1]=u,r[i+2]=v;var s=a+i,h=e+o,f=e+u,l=e+v;r[s]=h,r[s+1]=f,r[s+2]=l}n.index=r}(a,I(a.flatVertices,a.holes,2)),function(n,t){for(var r=n.points,e=n.index,i=n.polygon,a=n.uvs,o=t.depth,u=0,v=i.length;u<v;u++)for(var s=i[u],h=0,f=s.length;h<f;){var l=s[h],x=s[h+1];h===f-1&&(x=s[0]);var p=r.length/3,c=l[0],d=l[1],g=x[0],y=x[1];r.push(c,d,o,g,y,o,c,d,0,g,y,0);var m=p+2,w=p+3,M=p,b=p+1;e.push(m,M,w,M,b,w),W(a,r,m,w,M,b),h++}}(a,t),a.position=new Float32Array(a.points),a.indices=new Uint32Array(a.index),a.uv=new Float32Array(a.uvs),a.normal=U(a.indices,a.position),a})),e=j(r);return e.polygons=n,e}function B(n){V(n)||n.push(n[0])}function V(n){var t=n.length,r=n[0],e=r[0],i=r[1],a=n[t-1],o=a[0],u=a[1];return e===o&&i===u}function _(n,t){t=Object.assign({},{depth:2,lineWidth:1},t);var r=n.map((function(n){var r=function(n,t){var r=0,e=t.lineWidth/2,i=[],a=[],o=[],u=n.length,v=0;for(;v<u-1;){var s=n[v],h=n[v+1],f=h[1]-s[1],l=h[0]-s[0],x=0,p=O(Math.atan(f/l));if(r=p,0===v)x=p,x-=90;else{var c=n[v-1];q.x=c[0]-s[0],q.y=c[1]-s[1],R.x=h[0]-s[0],R.y=h[1]-s[1],x=p-D(q,R)/2}var d=C(S(x),e,s),g=d[0],y=d[1];i.push(g,y),G(g,s,h)?(a.push(g),o.push(y)):(a.push(y),o.push(g)),v++}var m=r,w=S(m-=90),M=n[u-2],b=n[u-1],A=C(w,e,b),Z=A[0],F=A[1];i.push(Z,F),G(Z,M,b)?(a.push(Z),o.push(F)):(a.push(F),o.push(Z));return{offsetPoints:i,leftPoints:a,rightPoints:o}}(n,t);return r.line=n,function(n,t){var r=t.depth,e=[],i=[],a=[],o=n.leftPoints,u=n.rightPoints,v=0,s=o.length;for(;v<s;){var h=3*v,f=o[v],l=f[0],x=f[1];e[h]=l,e[h+1]=x,e[h+2]=r;var p=u[v],c=p[0],d=p[1],g=3*s+h;e[g]=c,e[g+1]=d,e[g+2]=r;var y=2*s*3+h;e[y]=l,e[y+1]=x,e[y+2]=0;var m=2*s*3+3*s+h;e[m]=c,e[m+1]=d,e[m+2]=0,v++}v=0,s=e.length;for(;v<s;){var w=e[v],M=e[v+1];a.push(w,M),v+=3}v=0,s=o.length;for(;v<s-1;){var b=v,A=v+1,Z=b+s,F=A+s;i.push(b,Z,A),i.push(Z,F,A);var P=v+2*s,z=P+1,I=P+s,E=z+s;i.push(P,I,z),i.push(I,E,z),v++}n.index=i,n.points=e,n.uvs=a}(r,t),function(n,t){var r=n.points,e=n.index,i=n.leftPoints,a=n.rightPoints,o=n.uvs,u=t.depth,v=[i,a];function s(n,t){var i=r.length/3;r.push(n[0],n[1],u,t[0],t[1],u,n[0],n[1],0,t[0],t[1],0);var a=i+2,v=i+3,s=i,h=i+1;e.push(a,s,v,s,h,v),W(o,r,a,v,s,h)}for(var h=0,f=v.length;h<f;h++){var l=v[h];h>0&&(l=(l=l.map((function(n){return n}))).reverse());for(var x=0,p=l.length-1;x<p;){s(l[x],l[x+1]),x++}}for(var c=i.length,d=[a[0],i[0],i[c-1],a[c-1]],g=0;g<d.length;g+=2){s(d[g],d[g+1])}}(r,t),r.position=new Float32Array(r.points),r.indices=new Uint32Array(r.index),r.uv=new Float32Array(r.uvs),r.normal=U(r.indices,r.position),r})),e=j(r);return e.lines=n,e}var q={x:0,y:0},R={x:0,y:0};function C(n,t,r){var e=r[0],i=r[1],a=[e+Math.cos(n)*t,i+Math.sin(n)*t],o=n+=Math.PI;return[a,[e+Math.cos(o)*t,i+Math.sin(o)*t]]}var D=function(n,t){var r=n.x,e=n.y,i=t.x,a=t.y,o=r*i+e*a,u=r*a-e*i;return(Math.atan2(u,o)/Math.PI*180+360)%360};function G(n,t,r){var e=t[0],i=t[1],a=r[0],o=r[1];return(i-o)*n[0]+(a-e)*n[1]+e*o-a*i>0}function J(n,t){void 0===t&&(t={}),t=Object.assign({},{radius:1,height:2,radialSegments:6},t);for(var r=Math.round(Math.max(4,t.radialSegments)),e=t,i=e.radius,a=e.height,o=360/r/360*Math.PI*2,u=r+1,v=new Float32Array(3*u*2),s=n[0],h=n[1],f=0,l=0,x=3*u,p=2*u,c=[],d=[],g=-1;g<r;g++){var y=o*g,m=Math.cos(y)*i+s,w=Math.sin(y)*i+h;v[f]=m,v[f+1]=w,v[f+2]=0,v[f+x]=m,v[f+1+x]=w,v[f+2+x]=a;var M,b;M=.5+m/i/2,b=.5+w/i/2,d[l]=M,d[l+1]=b,d[l+p]=M,d[l+1+p]=b,f+=3,l+=2,g>1&&c.push(0,g-1,g)}v[f-=3]=v[0],v[f+1]=v[1],v[f+2]=v[2];var A=v.length;v[A-3]=v[0],v[A-2]=v[1],v[A-1]=a;for(var Z=c.length,F=0;F<Z;F++){var P=c[F];c.push(P+u)}var z=new Float32Array(2*(3*u*2-6)),I=-1;f=2*u,l=0;for(var E=0,L=v.length/2;E<L-3;E+=3){var H=v[E],j=v[E+1],O=v[E+3],S=v[E+4];z[++I]=H,z[++I]=j,z[++I]=a,z[++I]=O,z[++I]=S,z[++I]=a,z[++I]=H,z[++I]=j,z[++I]=0,z[++I]=O,z[++I]=S,z[++I]=0;var W=f+2,k=f+3,B=f,V=f+1;c.push(B,W,V,W,k,V),f+=4;var _=l/u,q=(l+1)/u;d.push(_,a/i/2,q,a/i/2,_,0,q,0),l++}var R=new Float32Array(v.length+z.length);R.set(v,0),R.set(z,v.length);var C=U(c,R);return{points:v,indices:new Uint32Array(c),position:R,normal:C,uv:new Float32Array(d)}}var K={x:0,y:0},N={x:0,y:0};function Q(n,t,r,e){for(var i=n.length,a=0;a<i;a++){var o=n[a].data;t=n[a].center||t;for(var u=0,v=o.length;u<v;u++)for(var s=o[u],h=0,f=s.length;h<f;h++)n[a].data[u][h]=T(s[h],t,r,e)}}function T(n,t,r,e){for(var i,a=[],o=0,u=(i=r?new Float64Array(n):new Float32Array(n)).length;o<u;o+=2){var v=i[o],s=i[o+1];if(t&&r&&e){K.x=v,K.y=s;var h=un(K,N);K.x=h.x,K.y=h.y,v=(h=vn(e,K,r,N)).x,s=h.y,v-=t[0],s-=t[1]}a.push([v,s])}return a}function X(n,t){void 0===t&&(t=!1);for(var r=n.length,e=[],i=[],a=0,o=0;o<r;o++){var u=t?$(n[o]):Y(n[o]),v=n[o].bottomHeight||0,s=u.position;i.push(u);var h=s.length/3;e[o]={position:{middleZ:v+(n[o].height||0)/2,count:h,start:a,end:a+3*h},hide:!1},a+=3*h}var f=tn(i),l=f.position,x=f.normal,p=f.uv,c=f.indices;return{position:l.buffer,normal:x.buffer,uv:p.buffer,indices:c.buffer,geometriesAttributes:e}}function Y(n){var t=n.data,r=n.height,e=n.bottomHeight,i=k(t,{depth:r}),a=i.position,o=i.normal,u=i.uv,v=i.indices;return rn(a,e),{position:a,normal:o,uv:u,indices:v}}function $(n){var t=n.data,r=n.height,e=n.width,i=n.bottomHeight,a=_(t,{lineWidth:e,depth:r}),o=a.position,u=a.normal,v=a.uv,s=a.indices;return rn(o,i),{position:o,normal:u,uv:v,indices:s}}function nn(n,t){for(var r=new Float32Array(t),e=0,i=0;i<n.length;++i)r.set(n[i],e),e+=n[i].length;return r}function tn(n){for(var t={},r={},e=0;e<n.length;++e){var i=n[e];for(var a in i)void 0===t[a]&&(t[a]=[],r[a]=0),t[a].push(i[a]),r[a]+=i[a].length}var o={},u=0,v=[];for(var s in t)if("indices"===s)for(var h=t[s],f=0,l=h.length;f<l;f++){for(var x=h[f],p=0,c=x.length;p<c;p++)v.push(x[p]+u);u+=t.position[f].length/3}else{var d=nn(t[s],r[s]);if(!d)return null;o[s]=d}return o.indices=new Uint32Array(v),o}function rn(n,t){if(void 0!==t&&"number"==typeof t&&0!==t)for(var r=0,e=n.length;r<e;r+=3)n[r+2]+=t}function en(n){for(var t=[],r=0,e=n.length;r<e;r+=7){var i=n[r],a=n[r+1],o=n[r+2],u=n[r+3],v=n[r+4],s=n[r+5];t.push({radialSegments:o,radius:u,height:v,altitude:s,center:[i,a]})}for(var h=t.length,f=[],l=[],x=0,p=0;p<h;p++){var c=J(t[p].center||[0,0],t[p]),d=c.position;if(t[p].altitude)for(var g=t[p].altitude,y=0,m=d.length;y<m;y+=3)c[y+2]+=g;l.push(c);var w=d.length/3;f[p]={position:{middleZ:t[p].height/2,count:w,start:x,end:x+3*w},hide:!1},x+=3*w}var M=tn(l),b=M.position,A=M.normal,Z=M.uv,F=M.indices;return{position:b.buffer,normal:A.buffer,uv:Z.buffer,indices:F.buffer,geometriesAttributes:f}}var an=Math.PI/180,on=6378137*Math.PI/180;function un(n,t){var r,e=85.0511287798,i=n.x,a=Math.max(Math.min(e,n.y),-e);r=0===a?0:Math.log(Math.tan((90+a)*an/2))/an;var o=i*on,u=r*on;return t?(t.x=o,t.y=u,t):{x:o,y:u}}function vn(n,t,r,e){var i=n[0]*(t.x-n[2])/r,a=-n[1]*(t.y-n[3])/r;return e?(e.x=i,e.y=a,e):{x:i,y:a}}function sn(n){void 0===n&&(n=[]);for(var t=n.length,r=new Float32Array(3*t),e=0;e<t;e++){var i=n[e],a=3*e;r[a]=i[0],r[a+1]=i[1]}return r}function hn(n){for(var t=new Float32Array(2*n.length-6),r=0,e=0,i=n.length/3;e<i;e++){var a=n[3*e],o=n[3*e+1],u=n[3*e+2];if(e>0&&e<i-1){var v=3*r;t[v]=a,t[v+1]=o,t[v+2]=u,r++}var s=3*r;t[s]=a,t[s+1]=o,t[s+2]=u,r++}return t}function fn(n){var t=0,r=n.length;if(1===r)return n[0];for(var e=0;e<r;e++)t+=n[e].length;for(var i=new Float32Array(t),a=0,o=0;o<r;o++)i.set(n[o],a),a+=n[o].length;return i}n.initialize=function(){},n.onmessage=function(n,t){var r=n.data,e=r.type,i=r.datas,a=r.glRes,o=r.matrix,u=r.center;if("ExtrudePolygons"===e){Q(i,u,a,o);var v=X(i);t(null,v,[v.position,v.normal,v.uv,v.indices])}else if("ExtrudeLines"===e){for(var s=0,h=i.length;s<h;s++)for(var f=0,l=i[s].data.length;f<l;f++)i[s].data[f]=T(i[s].data[f],i[s].center||u,a,o);var x=X(i,!0);t(null,x,[x.position,x.normal,x.uv,x.indices])}else if("ExtrudePolygon"===e){var p=[],c=[];i.forEach((function(n){var t=[n];Q(t,u,a,o);var r=X(t),e=r.position,i=r.normal,v=r.uv,s=r.indices;p.push({id:n.id,position:e,normal:i,uv:v,indices:s}),c.push(e,i,v,s)})),t(null,p,c)}else if("Line"===e||"FatLine"===e){for(var d=[],g=[],y=0,m=i.length;y<m;y++){for(var w=[],M=0,b=i[y].data.length;M<b;M++){i[y].data[M]=T(i[y].data[M],i[y].center||u,a,o);var A=sn(i[y].data[M]);w.push(hn(A))}var Z=fn(w);rn(Z,i[y].bottomHeight),d.push({id:i[y].id,position:Z.buffer}),g.push(Z.buffer)}t(null,d,g)}else if("Lines"===e||"FatLines"===e){for(var F=0,P=[],z=[],I=0,E=[],L=0,H=i.length;L<H;L++){for(var U=0,j=0,O=i[L].data.length;j<O;j++){i[L].data[j]=T(i[L].data[j],i[L].center||u,a,o);var S=sn(i[L].data[j]);rn(S,i[L].bottomHeight),U+=S.length/3*2-2,E.push(hn(S))}var W=U;P[L]=[F,F+W],F+=W,z[L]={position:{count:U,start:I,end:I+3*U},hide:!1},"FatLines"===e&&(z[L].instanceStart={count:U,start:I,end:I+3*U},z[L].instanceEnd={count:U,start:I,end:I+3*U}),I+=3*U}var k=fn(E);t(null,{id:i.id,position:k.buffer,geometriesAttributes:z,faceMap:P},[k.buffer])}else if("ExtrudeLine"===e){for(var B=0,V=i.length;B<V;B++)for(var _=0,q=i[B].data.length;_<q;_++)i[B].data[_]=T(i[B].data[_],i[B].center||u,a,o);var R=[],C=[];i.forEach((function(n){var t=X([n],!0),r=t.position,e=t.normal,i=t.uv,a=t.indices;R.push({id:n.id,position:r,normal:e,uv:i,indices:a}),C.push(r,e,i,a)})),t(null,R,C)}else if("Bar"===e){for(var D=[],G=[],J=(i=new Float32Array(i)).length/7,K=0;K<J;){var N=i.slice(7*K,7*(K+1)),Y=en(N),$=Y.position,nn=Y.normal,tn=Y.uv,an=Y.indices;D.push({id:parseInt(N[6]),position:$,normal:nn,uv:tn,indices:an}),G.push($,nn,tn,an),K++}t(null,D,G)}else if("Bars"===e){var on=en(i=new Float32Array(i));t(null,on,[on.position,on.normal,on.uv,on.indices])}},Object.defineProperty(n,"__esModule",{value:!0})})'),o.registerWorkerAdapter(Li,(function(t){const e=[],n=[];function i(t){t.abort?(n.splice(n.indexOf(t),1),e.length&&(n.push(e[0]),e.splice(0,1),r(n[n.length-1]))):n.length<5?(n.push(t),r(t)):e.push(t)}function r(t){fetch(t.url).then((t=>t.text())).then((e=>{new Blob([e],{type:"application/json"}).arrayBuffer().then((e=>{t.postResponse(null,e,[e]),t.abort=!0,i(t)}))})).catch((e=>{console.error(e),t.abort=!0,i(t)}))}t.initialize=function(){},t.onmessage=function(t,e){i({url:t.data,postResponse:e,abort:!1})}}))),t.BaseObject=m,t.BaseObjectTask=yt,t.BaseObjectTaskManager=St,t.ExtrudeUtil=K,t.GeoJSONUtil=k,t.GeoUtil=se,t.IdentifyUtil=xe,t.LineMaterial=f,t.LineUtil=st,t.MergeGeometryUtil=It,t.MergedMixin=de,t.ThreeLayer=Ri,t.ThreeRenderer=Zi,t.geometryExtrude=Pi,t.getFetchDataActor=function(){return o.worker||console.error("maptalks.worker is not defined,You can't use"),Bi||(Bi=new o.worker.Actor(Li)),Bi},t.polyextrude=B,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.35.1")}));
